{"version":3,"sources":["../src/orchestrator/intent-classifier.ts","../src/orchestrator/context-loader.ts","../src/orchestrator/agent-router.ts","../src/orchestrator/orchestrator.ts"],"sourcesContent":["/**\r\n * Intent Classifier\r\n * Determines which specialist should handle a user's question\r\n */\r\n\r\nimport type {\r\n  Domain,\r\n  SpecialistId,\r\n  IntentClassification,\r\n} from '../types';\r\nimport { DOMAIN_KEYWORDS, getAgentByDomain } from '../agents';\r\n\r\n/**\r\n * Work-focused keywords - indicates user is asking about work tasks\r\n */\r\nconst WORK_KEYWORDS = [\r\n  'help with', 'how do i', 'what is the', 'how to', 'can you help',\r\n  'need to', 'want to', 'report', 'fill in', 'complete', 'submit',\r\n  'guidance', 'advice', 'requirements', 'policy', 'procedure',\r\n];\r\n\r\n/**\r\n * Chat/non-work keywords - indicates user is just chatting\r\n */\r\nconst CHAT_KEYWORDS = [\r\n  'tell me a joke', 'how are you', 'what do you think', 'lets chat',\r\n  'conversation', 'just saying', 'bored', 'nothing', 'hi', 'hello',\r\n];\r\n\r\n/**\r\n * Complex decision keywords - indicates multi-perspective may be useful\r\n */\r\nconst COMPLEX_DECISION_KEYWORDS = [\r\n  'should we', 'should i', 'recommend', 'decision', 'choose',\r\n  'best', 'better', 'versus', 'vs', 'compare', 'option',\r\n  'switch', 'change', 'implement', 'introduce', 'start using',\r\n];\r\n\r\n/**\r\n * Score a domain based on keyword matches in the query\r\n */\r\nfunction scoreDomain(query: string, domain: Domain): number {\r\n  const keywords = DOMAIN_KEYWORDS[domain] || [];\r\n  const queryLower = query.toLowerCase();\r\n\r\n  let score = 0;\r\n  for (const keyword of keywords) {\r\n    if (queryLower.includes(keyword.toLowerCase())) {\r\n      score += 1;\r\n      // Bonus for multi-word matches\r\n      if (keyword.split(' ').length > 1) {\r\n        score += 0.5;\r\n      }\r\n    }\r\n  }\r\n\r\n  return score;\r\n}\r\n\r\n/**\r\n * Check if the query is work-related or general chat\r\n */\r\nexport function isWorkRelated(query: string): { isWorkRelated: boolean; confidence: number } {\r\n  const queryLower = query.toLowerCase().trim();\r\n\r\n  // Check for explicit chat keywords\r\n  const hasChatKeywords = CHAT_KEYWORDS.some(kw => queryLower.includes(kw));\r\n\r\n  // Check for work keywords\r\n  const hasWorkKeywords = WORK_KEYWORDS.some(kw => queryLower.includes(kw));\r\n\r\n  // Also check domain keywords (if any, it's work-related)\r\n  const hasDomainKeywords = Object.values(DOMAIN_KEYWORDS).some(keywords =>\r\n    keywords.some(kw => queryLower.includes(kw.toLowerCase()))\r\n  );\r\n\r\n  if (hasChatKeywords && !hasWorkKeywords && !hasDomainKeywords) {\r\n    return { isWorkRelated: false, confidence: 0.9 };\r\n  }\r\n\r\n  if (hasWorkKeywords || hasDomainKeywords) {\r\n    return { isWorkRelated: true, confidence: 0.8 };\r\n  }\r\n\r\n  // If unclear, lean toward work-related (better to route to specialist than block)\r\n  return { isWorkRelated: true, confidence: 0.5 };\r\n}\r\n\r\n/**\r\n * Check if the query requires multi-perspective response\r\n */\r\nexport function requiresMultiPerspective(query: string): boolean {\r\n  const queryLower = query.toLowerCase();\r\n\r\n  // Check for complex decision keywords\r\n  const hasComplexKeyword = COMPLEX_DECISION_KEYWORDS.some(kw =>\r\n    queryLower.includes(kw)\r\n  );\r\n\r\n  return hasComplexKeyword;\r\n}\r\n\r\n/**\r\n * Classify the intent and route to appropriate specialist\r\n */\r\nexport function classifyIntent(\r\n  query: string,\r\n  activeApp?: string,\r\n  userRole?: string\r\n): IntentClassification {\r\n  const queryLower = query.toLowerCase();\r\n\r\n  // Check if work-related\r\n  const { isWorkRelated } = isWorkRelated(query);\r\n\r\n  if (!isWorkRelated) {\r\n    return {\r\n      domain: 'general',\r\n      specialist: 'ed-general',\r\n      confidence: 0.9,\r\n      reasoning: 'Query appears to be general chat, not work-related',\r\n      requiresMultiPerspective: false,\r\n      isWorkRelated: false,\r\n    };\r\n  }\r\n\r\n  // Check for complex decision (multi-perspective)\r\n  const needsMultiPerspective = requiresMultiPerspective(query);\r\n\r\n  // Score each domain\r\n  const domainScores: { domain: Domain; score: number }[] = [];\r\n\r\n  for (const domain of Object.keys(DOMAIN_KEYWORDS) as Domain[]) {\r\n    if (domain === 'general') continue;\r\n    const score = scoreDomain(query, domain);\r\n    if (score > 0) {\r\n      domainScores.push({ domain, score });\r\n    }\r\n  }\r\n\r\n  // Sort by score descending\r\n  domainScores.sort((a, b) => b.score - a.score);\r\n\r\n  // Determine best domain\r\n  let bestDomain: Domain;\r\n  let confidence: number;\r\n\r\n  if (domainScores.length > 0) {\r\n    bestDomain = domainScores[0].domain;\r\n    // Confidence based on how clear the winner is\r\n    const topScore = domainScores[0].score;\r\n    const secondScore = domainScores[1]?.score || 0;\r\n    confidence = Math.min(0.95, 0.6 + (topScore - secondScore) * 0.1);\r\n  } else {\r\n    // No clear domain - use active app if available\r\n    bestDomain = 'general';\r\n    confidence = 0.3;\r\n  }\r\n\r\n  // Override based on active app if no clear keywords\r\n  if (confidence < 0.5 && activeApp) {\r\n    switch (activeApp) {\r\n      case 'estates-compliance':\r\n        bestDomain = 'estates';\r\n        confidence = 0.7;\r\n        break;\r\n      case 'hr':\r\n        bestDomain = 'hr';\r\n        confidence = 0.7;\r\n        break;\r\n    }\r\n  }\r\n\r\n  // Get specialist for domain\r\n  const agent = getAgentByDomain(bestDomain);\r\n  const specialist = agent.id;\r\n\r\n  return {\r\n    domain: bestDomain,\r\n    specialist,\r\n    confidence,\r\n    reasoning: domainScores.length > 0\r\n      ? `Matched keywords for ${bestDomain} domain (score: ${domainScores[0].score})`\r\n      : `Using ${bestDomain} based on app context`,\r\n    requiresMultiPerspective: needsMultiPerspective,\r\n    isWorkRelated: true,\r\n  };\r\n}\r\n\r\n/**\r\n * Get explanation of routing decision (for logging/debug)\r\n */\r\nexport function explainRouting(classification: IntentClassification): string {\r\n  const parts = [\r\n    `Domain: ${classification.domain}`,\r\n    `Specialist: ${classification.specialist}`,\r\n    `Confidence: ${Math.round(classification.confidence * 100)}%`,\r\n  ];\r\n\r\n  if (classification.reasoning) {\r\n    parts.push(`Reasoning: ${classification.reasoning}`);\r\n  }\r\n\r\n  if (classification.requiresMultiPerspective) {\r\n    parts.push('Multi-perspective: Yes (complex decision)');\r\n  }\r\n\r\n  return parts.join(' | ');\r\n}\r\n","/**\r\n * Context Loader\r\n * Loads school context from DfE database\r\n */\r\n\r\nimport type { SchoolContext } from '../types';\r\n\r\n/**\r\n * Load school context from DfE database\r\n *\r\n * Note: This is a placeholder implementation. In production, this would:\r\n * 1. Get the organization's school URN from Supabase\r\n * 2. Call lookupSchoolByURN from supabase-dfe.ts\r\n * 3. Transform the result into SchoolContext\r\n */\r\nexport async function loadSchoolContext(\r\n  orgId: string,\r\n  supabase: any\r\n): Promise<SchoolContext | null> {\r\n  try {\r\n    // Placeholder - in production would be:\r\n    /*\r\n    // Get school URN from organization\r\n    const { data: org } = await supabase\r\n      .from('organizations')\r\n      .select('school_urn')\r\n      .eq('id', orgId)\r\n      .single();\r\n\r\n    if (!org?.school_urn) {\r\n      return null;\r\n    }\r\n\r\n    // Import and use the DfE lookup function\r\n    const { lookupSchoolByURN } = await import('@schoolgle/platform/lib/supabase-dfe');\r\n    const schoolData = await lookupSchoolByURN(org.school_urn);\r\n\r\n    if (!schoolData) {\r\n      return null;\r\n    }\r\n\r\n    return transformToSchoolContext(schoolData);\r\n    */\r\n\r\n    return null;\r\n  } catch (error) {\r\n    // Don't fail entire request if context loading fails\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Transform DfE school data to SchoolContext\r\n */\r\nfunction transformToSchoolContext(dfeData: any): SchoolContext {\r\n  return {\r\n    urn: dfeData.urn,\r\n    name: dfeData.name,\r\n    address: dfeData.address || [],\r\n    phone: dfeData.phone,\r\n    email: dfeData.email,\r\n    typeName: dfeData.type_name,\r\n    phaseName: dfeData.phase_name,\r\n    laCode: dfeData.la_code,\r\n    laName: dfeData.la_name,\r\n    trustName: dfeData.trust_name,\r\n    ofstedRating: dfeData.ofsted_rating,\r\n    ofstedLastInspection: dfeData.ofsted_last_inspection\r\n      ? new Date(dfeData.ofsted_last_inspection)\r\n      : undefined,\r\n    imdDecile: dfeData.imd_decile,\r\n    isIndependent: dfeData.type_name?.toLowerCase().includes('independent'),\r\n  };\r\n}\r\n\r\n/**\r\n * Build enriched prompt with school context\r\n */\r\nexport function buildEnrichedPrompt(\r\n  basePrompt: string,\r\n  schoolContext: SchoolContext | null\r\n): string {\r\n  if (!schoolContext) {\r\n    return basePrompt;\r\n  }\r\n\r\n  const contextBlock = buildSchoolContextBlock(schoolContext);\r\n\r\n  return `${contextBlock}\\n\\n${basePrompt}`;\r\n}\r\n\r\n/**\r\n * Build school context block for prompts\r\n */\r\nexport function buildSchoolContextBlock(schoolContext: SchoolContext): string {\r\n  const parts = [\r\n    '## School Context',\r\n    `You are helping **${schoolContext.name}**`,\r\n    '',\r\n  ];\r\n\r\n  // Add phase\r\n  if (schoolContext.phaseName) {\r\n    parts.push(`- **Type:** ${schoolContext.phaseName}`);\r\n  }\r\n\r\n  // Add trust if applicable\r\n  if (schoolContext.trustName) {\r\n    parts.push(`- **Trust:** ${schoolContext.trustName}`);\r\n  }\r\n\r\n  // Add LA info if not a trust\r\n  if (schoolContext.laName && !schoolContext.trustName) {\r\n    parts.push(`- **Local Authority:** ${schoolContext.laName}`);\r\n  }\r\n\r\n  // Add Ofsted info if available\r\n  if (schoolContext.ofstedRating) {\r\n    parts.push(`- **Ofsted Rating:** ${schoolContext.ofstedRating}`);\r\n  }\r\n\r\n  // Add deprivation context if available\r\n  if (schoolContext.imdDecile !== undefined) {\r\n    const deprivationLevel = schoolContext.imdDecile <= 3\r\n      ? 'high deprivation area'\r\n      : schoolContext.imdDecile <= 7\r\n      ? 'average deprivation'\r\n      : 'low deprivation area';\r\n    parts.push(`- **Context:** ${deprivationLevel} (IMD decile ${schoolContext.imdDecile}/10)`);\r\n  }\r\n\r\n  parts.push('');\r\n  parts.push('Use this context to provide relevant, tailored advice.');\r\n  parts.push('');\r\n\r\n  return parts.join('\\n');\r\n}\r\n\r\n/**\r\n * Get relevant guidance based on school type\r\n */\r\nexport function getTypeSpecificGuidance(schoolContext: SchoolContext): string[] {\r\n  const guidance: string[] = [];\r\n\r\n  // Academy vs LA-maintained differences\r\n  if (schoolContext.trustName) {\r\n    guidance.push('This is an academy trust - check trust policies in addition to national guidance.');\r\n  } else if (schoolContext.typeName?.toLowerCase().includes('la-maintained') ||\r\n             schoolContext.typeName?.toLowerCase().includes('local authority')) {\r\n    guidance.push('This is an LA-maintained school - the local authority may provide additional guidance and services.');\r\n  }\r\n\r\n  // Independent school considerations\r\n  if (schoolContext.isIndependent) {\r\n    guidance.push('This is an independent school - some statutory requirements may differ, particularly around inspection and curriculum.');\r\n  }\r\n\r\n  // Phase-specific guidance\r\n  if (schoolContext.phaseName?.toLowerCase().includes('primary')) {\r\n    guidance.push('Primary school context: Consider early years and key stage 1-2 specific requirements.');\r\n  } else if (schoolContext.phaseName?.toLowerCase().includes('secondary')) {\r\n    guidance.push('Secondary school context: Consider key stage 3-5, GCSE, and post-16 specific requirements.');\r\n  }\r\n\r\n  return guidance;\r\n}\r\n","/**\r\n * Agent Router\r\n * Routes questions to appropriate specialist agent and generates LLM responses\r\n */\r\n\r\nimport type {\r\n  AppContext,\r\n  SpecialistId,\r\n  AgentResponse,\r\n  SchoolContext,\r\n} from '../types';\r\nimport { AGENTS, getAgent } from '../agents';\r\nimport { classifyIntent } from './intent-classifier';\r\nimport { queryKnowledgeBase } from '../knowledge-base/query';\r\nimport { getModelRouter } from '../models';\r\nimport { buildEnrichedPrompt, getTypeSpecificGuidance, buildSchoolContextBlock } from './context-loader';\r\n\r\n/**\r\n * Route question to appropriate specialist and get response\r\n */\r\nexport async function routeToSpecialist(\r\n  question: string,\r\n  context: AppContext\r\n): Promise<AgentResponse> {\r\n  // 1. Classify intent\r\n  const classification = classifyIntent(\r\n    question,\r\n    context.activeApp,\r\n    context.userRole\r\n  );\r\n\r\n  // 2. Check if user has access to this feature\r\n  if (!hasFeatureAccess(context, classification.domain)) {\r\n    return {\r\n      agentId: 'ed-general',\r\n      content: getUpgradeMessage(classification.domain),\r\n      confidence: 'HIGH',\r\n      requiresHuman: false,\r\n      metadata: { blocked: 'feature_access' },\r\n    };\r\n  }\r\n\r\n  // 3. Check knowledge base first (for high-confidence factual queries)\r\n  if (classification.confidence > 0.7 && classification.isWorkRelated) {\r\n    const cached = await queryKnowledgeBase(question, classification.domain);\r\n    if (cached && cached.confidence === 'HIGH') {\r\n      return {\r\n        agentId: classification.specialist,\r\n        content: formatCachedResponse(cached),\r\n        sources: [{\r\n          name: cached.sourceName,\r\n          url: cached.sourceUrl,\r\n          type: cached.sourceType,\r\n          lastVerified: cached.lastVerified,\r\n        }],\r\n        confidence: cached.confidence,\r\n        metadata: { cached: true, knowledgeId: cached.id },\r\n      };\r\n    }\r\n  }\r\n\r\n  // 4. Get specialist agent definition\r\n  const agent = getAgent(classification.specialist);\r\n  if (!agent) {\r\n    throw new Error(`Specialist not found: ${classification.specialist}`);\r\n  }\r\n\r\n  // 5. Build enriched prompt with school context\r\n  const enrichedPrompt = buildSpecialistPrompt(\r\n    agent.systemPrompt,\r\n    context.schoolData,\r\n    question\r\n  );\r\n\r\n  // 6. Call LLM via OpenRouter\r\n  const modelRouter = getModelRouter();\r\n  const model = modelRouter.selectModel('specialist-response', context);\r\n\r\n  try {\r\n    const llmResponse = await modelRouter.chat(\r\n      enrichedPrompt,\r\n      question,\r\n      {\r\n        model: model.id,\r\n        temperature: 0.7,\r\n        maxTokens: 2048,\r\n      }\r\n    );\r\n\r\n    // 7. Format response\r\n    return {\r\n      agentId: classification.specialist,\r\n      content: llmResponse.content,\r\n      sources: [{\r\n        name: `${agent.name} (AI)`,\r\n        type: 'AI Specialist',\r\n      }],\r\n      confidence: 'MEDIUM',\r\n      metadata: {\r\n        classification,\r\n        modelUsed: model.id,\r\n        tokensUsed: {\r\n          input: llmResponse.usage.promptTokens,\r\n          output: llmResponse.usage.completionTokens,\r\n          total: llmResponse.usage.totalTokens,\r\n        },\r\n      },\r\n    };\r\n\r\n  } catch (error) {\r\n    // Handle LLM errors gracefully\r\n    return {\r\n      agentId: classification.specialist,\r\n      content: getErrorMessage(error),\r\n      confidence: 'LOW',\r\n      requiresHuman: true,\r\n      metadata: {\r\n        classification,\r\n        modelUsed: model.id,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      },\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Build specialist prompt with school context\r\n */\r\nfunction buildSpecialistPrompt(\r\n  basePrompt: string,\r\n  schoolContext: SchoolContext | null | undefined,\r\n  question: string\r\n): string {\r\n  let prompt = basePrompt;\r\n\r\n  // Add school context if available\r\n  if (schoolContext) {\r\n    const contextBlock = buildSchoolContextBlock(schoolContext);\r\n    prompt = `${contextBlock}\\n\\n${prompt}`;\r\n\r\n    // Add type-specific guidance\r\n    const typeGuidance = getTypeSpecificGuidance(schoolContext);\r\n    if (typeGuidance.length > 0) {\r\n      prompt = `${prompt}\\n\\n## Additional Context for This School\\n\\n${typeGuidance.join('\\n')}`;\r\n    }\r\n  }\r\n\r\n  return prompt;\r\n}\r\n\r\n/**\r\n * Check if user has access to the feature/domain\r\n */\r\nfunction hasFeatureAccess(context: AppContext, domain: string): boolean {\r\n  if (context.subscription.plan === 'free') {\r\n    return ['general', 'it-tech'].includes(domain);\r\n  }\r\n\r\n  if (context.subscription.plan === 'schools') {\r\n    return !['procurement', 'governance'].includes(domain);\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\n/**\r\n * Get upgrade message for locked features\r\n */\r\nfunction getUpgradeMessage(domain: string): string {\r\n  const upgradeMessages: Record<string, string> = {\r\n    estates: 'Estates Compliance support is available on the Schools plan. Upgrade to access RIDDOR, fire safety, and compliance guidance.',\r\n    hr: 'HR support is available on the Schools plan. Upgrade to access sickness, absence, and employment guidance.',\r\n    send: 'SEND support is available on the Schools plan. Upgrade to access EHCP and SEND guidance.',\r\n    data: 'Data support is available on the Schools plan. Upgrade to access census and data protection guidance.',\r\n    curriculum: 'Curriculum support is available on the Schools plan. Upgrade to access Ofsted and curriculum guidance.',\r\n    procurement: 'Procurement support is available on the Trusts plan. Upgrade to access framework and procurement guidance.',\r\n    governance: 'Governance support is available on the Trusts plan. Upgrade to access trust governance guidance.',\r\n    communications: 'Communications support is available on the Schools plan. Upgrade to access parent and media guidance.',\r\n  };\r\n\r\n  return upgradeMessages[domain] || 'This feature is not available on your current plan.';\r\n}\r\n\r\n/**\r\n * Format cached knowledge base response\r\n */\r\nfunction formatCachedResponse(cached: any): string {\r\n  return `${cached.answer}\r\n\r\n---\r\n*This information is from ${cached.sourceName} and was last verified on ${new Date(cached.lastVerified).toLocaleDateString()}.*`;\r\n}\r\n\r\n/**\r\n * Get error message for LLM failures\r\n */\r\nfunction getErrorMessage(error: unknown): string {\r\n  if (error instanceof Error) {\r\n    return `I'm having trouble connecting to my knowledge base right now.\r\n\r\n**Error:** ${error.message}\r\n\r\nPlease try again in a moment. If this continues, please contact support.`;\r\n  }\r\n  return 'I encountered an error processing your request. Please try again.';\r\n}\r\n","/**\r\n * Ed Orchestrator - Main entry point for processing user questions through the agent framework\r\n */\r\n\r\nimport type {\r\n  OrchestratorConfig,\r\n  AppContext,\r\n  EdResponse,\r\n} from '../types';\r\nimport { routeToSpecialist } from './agent-router';\r\nimport { classifyIntent, isWorkRelated } from './intent-classifier';\r\nimport { createCreditManager } from '../credit/manager';\r\nimport { applyGuardrails } from '../guardrails/pipeline';\r\nimport { generateMultiPerspectiveResponse } from '../perspectives/generator';\r\nimport { loadSchoolContext } from './context-loader';\r\n\r\n/**\r\n * Ed Orchestrator - coordinates all agent processing\r\n */\r\nexport class EdOrchestrator {\r\n  private config: OrchestratorConfig;\r\n  private creditManager: ReturnType<typeof createCreditManager>;\r\n  private schoolContext: AppContext['schoolData'] | null = null;\r\n  private totalTokensUsed = 0;\r\n\r\n  constructor(config: OrchestratorConfig) {\r\n    this.config = config;\r\n    this.creditManager = createCreditManager(config.subscription);\r\n    this.schoolContext = config.schoolData || null;\r\n  }\r\n\r\n  /**\r\n   * Process a user question through the agent framework\r\n   */\r\n  async processQuestion(\r\n    question: string,\r\n    context: {\r\n      app?: string;\r\n      page?: string;\r\n      screenshot?: string;\r\n    } = {}\r\n  ): Promise<EdResponse> {\r\n    const startTime = Date.now();\r\n\r\n    // Build full app context\r\n    const appContext: AppContext = {\r\n      userId: this.config.userId,\r\n      orgId: this.config.orgId,\r\n      userRole: this.config.userRole,\r\n      subscription: this.config.subscription,\r\n      activeApp: (context.app as any) || this.config.activeApp,\r\n      currentTask: context.page,\r\n      schoolData: this.schoolContext,\r\n      sessionId: this.generateSessionId(),\r\n    };\r\n\r\n    // Load school context if not already loaded\r\n    if (!this.schoolContext && this.config.supabase) {\r\n      try {\r\n        this.schoolContext = await loadSchoolContext(this.config.orgId, this.config.supabase);\r\n        appContext.schoolData = this.schoolContext;\r\n      } catch {\r\n        // Don't fail if context loading fails\r\n      }\r\n    }\r\n\r\n    try {\r\n      // Step 1: Classify intent and check if work-related\r\n      const classification = classifyIntent(\r\n        question,\r\n        appContext.activeApp,\r\n        appContext.userRole\r\n      );\r\n\r\n      // If not work-related, return redirect message\r\n      if (!classification.isWorkRelated) {\r\n        return {\r\n          response: this.getWorkFocusRedirect(),\r\n          specialist: 'ed-general',\r\n          confidence: 'HIGH',\r\n          sources: [],\r\n          requiresHuman: false,\r\n          metadata: {\r\n            domain: 'general',\r\n            processedAt: new Date(),\r\n          },\r\n        };\r\n      }\r\n\r\n      // Step 2: Route to specialist and get initial response\r\n      const agentResponse = await routeToSpecialist(question, appContext);\r\n\r\n      // Track tokens from specialist response\r\n      if (agentResponse.metadata?.tokensUsed) {\r\n        const tokens = agentResponse.metadata.tokensUsed as { total: number };\r\n        this.totalTokensUsed += tokens.total;\r\n      }\r\n\r\n      // Step 3: Check if multi-perspective is needed\r\n      let finalContent = agentResponse.content;\r\n      let perspectives: EdResponse['perspectives'] | undefined;\r\n      let additionalTokens = 0;\r\n\r\n      if (classification.requiresMultiPerspective && this.config.enableMultiPerspective !== false) {\r\n        const perspectiveResponse = await generateMultiPerspectiveResponse(\r\n          question,\r\n          agentResponse.content,\r\n          appContext\r\n        );\r\n        finalContent = perspectiveResponse.synthesized;\r\n        perspectives = perspectiveResponse.perspectives;\r\n\r\n        // Estimate perspective tokens (roughly: 3 perspectives + synthesis)\r\n        additionalTokens = 800; // Approximate\r\n        this.totalTokensUsed += additionalTokens;\r\n      }\r\n\r\n      // Step 4: Apply guardrails\r\n      const guardedResponse = await applyGuardrails(\r\n        finalContent,\r\n        appContext,\r\n        (await this.getDomainForSpecialist(agentResponse.agentId)) || undefined\r\n      );\r\n\r\n      // Estimate guardrails tokens\r\n      this.totalTokensUsed += 200; // Rough estimate for guardrails checks\r\n\r\n      // Step 5: Format final response\r\n      const response: EdResponse = {\r\n        response: guardedResponse.response,\r\n        specialist: agentResponse.agentId,\r\n        confidence: agentResponse.confidence,\r\n        sources: agentResponse.sources || [],\r\n        requiresHuman: guardedResponse.requiresHuman || agentResponse.requiresHuman || false,\r\n        warnings: guardedResponse.warning ? [guardedResponse.warning] : undefined,\r\n        perspectives,\r\n        metadata: {\r\n          domain: (await this.getDomainForSpecialist(agentResponse.agentId)) || 'general',\r\n          tokensUsed: {\r\n            input: Math.round(this.totalTokensUsed * 0.4),\r\n            output: Math.round(this.totalTokensUsed * 0.6),\r\n            total: this.totalTokensUsed,\r\n            cost: this.estimateCost(this.totalTokensUsed),\r\n          },\r\n          processedAt: new Date(),\r\n          cached: (agentResponse.metadata as any)?.cached,\r\n          perspectiveUsed: !!perspectives,\r\n        },\r\n      };\r\n\r\n      return response;\r\n\r\n    } catch (error) {\r\n      // Handle errors gracefully\r\n      return {\r\n        response: this.getErrorResponse(error),\r\n        specialist: 'ed-general',\r\n        confidence: 'LOW',\r\n        sources: [],\r\n        requiresHuman: true,\r\n        warnings: ['An error occurred while processing your question.'],\r\n        metadata: {\r\n          domain: 'general',\r\n          processedAt: new Date(),\r\n          error: error instanceof Error ? error.message : 'Unknown error',\r\n        },\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get school context\r\n   */\r\n  getSchoolContext() {\r\n    return this.schoolContext;\r\n  }\r\n\r\n  /**\r\n   * Update school context\r\n   */\r\n  setSchoolContext(context: AppContext['schoolData']) {\r\n    this.schoolContext = context;\r\n  }\r\n\r\n  /**\r\n   * Get credit summary\r\n   */\r\n  getCreditSummary() {\r\n    const baseSummary = this.creditManager.getSummary();\r\n    return {\r\n      ...baseSummary,\r\n      totalSessionTokens: this.totalTokensUsed,\r\n      estimatedCost: this.estimateCost(this.totalTokensUsed),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get total tokens used this session\r\n   */\r\n  getTotalTokensUsed(): number {\r\n    return this.totalTokensUsed;\r\n  }\r\n\r\n  /**\r\n   * Reset session\r\n   */\r\n  resetSession() {\r\n    this.totalTokensUsed = 0;\r\n    this.creditManager.resetSession();\r\n  }\r\n\r\n  /**\r\n   * Generate session ID\r\n   */\r\n  private generateSessionId(): string {\r\n    return `session_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;\r\n  }\r\n\r\n  /**\r\n   * Get domain for specialist\r\n   */\r\n  private async getDomainForSpecialist(specialistId: string): Promise<string | undefined> {\r\n    const { getAgent } = await import('../agents');\r\n    const agent = getAgent(specialistId as any);\r\n    return agent?.domain;\r\n  }\r\n\r\n  /**\r\n   * Estimate cost based on tokens used\r\n   */\r\n  private estimateCost(tokens: number): number {\r\n    // Rough estimate using average model cost\r\n    const avgCostPerMillion = 1.0; // $1 per million tokens\r\n    return (tokens / 1_000_000) * avgCostPerMillion;\r\n  }\r\n\r\n  /**\r\n   * Get work focus redirect message\r\n   */\r\n  private getWorkFocusRedirect(): string {\r\n    return `Hi! I'm Ed, and I'm here to help you get work done.\r\n\r\nI can help with things like:\r\n• School compliance (RIDDOR, fire safety, legionella)\r\n• HR questions (sickness, policies, contracts)\r\n• Data reporting (census, returns)\r\n• Using school systems (SIMS, Arbor, etc.)\r\n• And much more...\r\n\r\nWhat work task can I help you with right now?`;\r\n  }\r\n\r\n  /**\r\n   * Get error response\r\n   */\r\n  private getErrorResponse(error: unknown): string {\r\n    if (error instanceof Error) {\r\n      // Check for specific error types\r\n      if (error.message.includes('401') || error.message.includes('Unauthorized')) {\r\n        return `I'm having trouble connecting to my AI services right now.\r\n\r\nThis might be an API configuration issue. Please try again or contact support.`;\r\n      }\r\n\r\n      if (error.message.includes('429') || error.message.includes('rate limit')) {\r\n        return `I'm receiving too many requests right now.\r\n\r\nPlease wait a moment and try again.`;\r\n      }\r\n\r\n      return `I'm sorry, something went wrong while trying to help you.\r\n\r\n**Error:** ${error.message}\r\n\r\nIf this continues, please contact support.`;\r\n    }\r\n    return 'I encountered an error processing your request. Please try again.';\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Factory Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Create orchestrator with config\r\n */\r\nexport async function createOrchestrator(config: OrchestratorConfig): Promise<EdOrchestrator> {\r\n  // Load school context if orgId provided and not already loaded\r\n  let schoolContext = config.schoolData;\r\n  if (config.orgId && !schoolContext && config.supabase) {\r\n    try {\r\n      schoolContext = await loadSchoolContext(config.orgId, config.supabase);\r\n    } catch {\r\n      // Don't fail entire orchestrator if context loading fails\r\n    }\r\n  }\r\n\r\n  return new EdOrchestrator({\r\n    ...config,\r\n    schoolData: schoolContext || undefined,\r\n  });\r\n}\r\n\r\n/**\r\n * Create a simple orchestrator for testing\r\n */\r\nexport function createTestOrchestrator(overrides?: Partial<OrchestratorConfig>): EdOrchestrator {\r\n  return new EdOrchestrator({\r\n    supabase: null,\r\n    userId: 'test-user',\r\n    orgId: 'test-org',\r\n    userRole: 'staff',\r\n    subscription: {\r\n      plan: 'schools',\r\n      features: ['estates', 'hr', 'send', 'data', 'curriculum'],\r\n      creditsRemaining: 10000,\r\n      creditsUsed: 0,\r\n    },\r\n    enableMultiPerspective: false,\r\n    enableBrowserAutomation: false,\r\n    debug: true,\r\n    ...overrides,\r\n  });\r\n}\r\n"],"mappings":"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","names":["isWorkRelated","getAgent"]}