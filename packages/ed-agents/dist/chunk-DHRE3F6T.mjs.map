{"version":3,"sources":["../src/credit/manager.ts"],"sourcesContent":["/**\r\n * Credit Manager\r\n * Tracks and manages credit usage\r\n */\r\n\r\nimport type { TokenUsage, SubscriptionContext } from '../types';\r\nimport { calculateCost } from '../models/router';\r\n\r\n/**\r\n * Credit manager state\r\n */\r\ninterface CreditState {\r\n  subscription: SubscriptionContext;\r\n  sessionUsage: number;\r\n  lastReset: Date;\r\n}\r\n\r\n/**\r\n * Credit Manager class\r\n */\r\nexport class CreditManager {\r\n  private state: CreditState;\r\n\r\n  constructor(subscription: SubscriptionContext) {\r\n    this.state = {\r\n      subscription,\r\n      sessionUsage: 0,\r\n      lastReset: new Date(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Track credit usage for a request\r\n   */\r\n  trackUsage(modelId: string, inputTokens: number, outputTokens: number): TokenUsage {\r\n    const cost = calculateCost(modelId, inputTokens, outputTokens);\r\n    const totalTokens = inputTokens + outputTokens;\r\n\r\n    this.state.sessionUsage += cost;\r\n\r\n    return {\r\n      input: inputTokens,\r\n      output: outputTokens,\r\n      total: totalTokens,\r\n      cost,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get remaining credits\r\n   */\r\n  getRemainingCredits(): number {\r\n    return Math.max(0, this.state.subscription.creditsRemaining - this.state.sessionUsage);\r\n  }\r\n\r\n  /**\r\n   * Get session usage\r\n   */\r\n  getSessionUsage(): number {\r\n    return this.state.sessionUsage;\r\n  }\r\n\r\n  /**\r\n   * Check if user has sufficient credits\r\n   */\r\n  hasSufficientCredits(estimatedCost: number): boolean {\r\n    return this.getRemainingCredits() >= estimatedCost;\r\n  }\r\n\r\n  /**\r\n   * Get subscription plan\r\n   */\r\n  getPlan(): SubscriptionContext['plan'] {\r\n    return this.state.subscription.plan;\r\n  }\r\n\r\n  /**\r\n   * Update subscription (e.g., after credits purchased)\r\n   */\r\n  updateSubscription(subscription: Partial<SubscriptionContext>): void {\r\n    this.state.subscription = { ...this.state.subscription, ...subscription };\r\n  }\r\n\r\n  /**\r\n   * Get credit usage summary\r\n   */\r\n  getSummary(): {\r\n    plan: string;\r\n    creditsRemaining: number;\r\n    sessionUsage: number;\r\n    estimatedRemaining: number;\r\n  } {\r\n    return {\r\n      plan: this.state.subscription.plan,\r\n      creditsRemaining: this.state.subscription.creditsRemaining,\r\n      sessionUsage: this.state.sessionUsage,\r\n      estimatedRemaining: this.getRemainingCredits(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Reset session usage\r\n   */\r\n  resetSession(): void {\r\n    this.state.sessionUsage = 0;\r\n    this.state.lastReset = new Date();\r\n  }\r\n}\r\n\r\n/**\r\n * Create a credit manager from subscription context\r\n */\r\nexport function createCreditManager(subscription: SubscriptionContext): CreditManager {\r\n  return new CreditManager(subscription);\r\n}\r\n"],"mappings":";;;;;;;;AAoBO,IAAM,gBAAN,MAAoB;AAAA,EAGzB,YAAY,cAAmC;AAC7C,SAAK,QAAQ;AAAA,MACX;AAAA,MACA,cAAc;AAAA,MACd,WAAW,oBAAI,KAAK;AAAA,IACtB;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,WAAW,SAAiB,aAAqB,cAAkC;AACjF,UAAM,OAAO,cAAc,SAAS,aAAa,YAAY;AAC7D,UAAM,cAAc,cAAc;AAElC,SAAK,MAAM,gBAAgB;AAE3B,WAAO;AAAA,MACL,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,OAAO;AAAA,MACP;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,sBAA8B;AAC5B,WAAO,KAAK,IAAI,GAAG,KAAK,MAAM,aAAa,mBAAmB,KAAK,MAAM,YAAY;AAAA,EACvF;AAAA;AAAA;AAAA;AAAA,EAKA,kBAA0B;AACxB,WAAO,KAAK,MAAM;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,qBAAqB,eAAgC;AACnD,WAAO,KAAK,oBAAoB,KAAK;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA,EAKA,UAAuC;AACrC,WAAO,KAAK,MAAM,aAAa;AAAA,EACjC;AAAA;AAAA;AAAA;AAAA,EAKA,mBAAmB,cAAkD;AACnE,SAAK,MAAM,eAAe,kCAAK,KAAK,MAAM,eAAiB;AAAA,EAC7D;AAAA;AAAA;AAAA;AAAA,EAKA,aAKE;AACA,WAAO;AAAA,MACL,MAAM,KAAK,MAAM,aAAa;AAAA,MAC9B,kBAAkB,KAAK,MAAM,aAAa;AAAA,MAC1C,cAAc,KAAK,MAAM;AAAA,MACzB,oBAAoB,KAAK,oBAAoB;AAAA,IAC/C;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,eAAqB;AACnB,SAAK,MAAM,eAAe;AAC1B,SAAK,MAAM,YAAY,oBAAI,KAAK;AAAA,EAClC;AACF;AAKO,SAAS,oBAAoB,cAAkD;AACpF,SAAO,IAAI,cAAc,YAAY;AACvC;","names":[]}