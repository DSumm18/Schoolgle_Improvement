{"version":3,"sources":["../src/guardrails/pipeline.ts"],"sourcesContent":["/**\r\n * Guardrails Pipeline\r\n * Applies all guardrails to responses before returning to user\r\n */\r\n\r\nimport type { GuardrailResult, AppContext } from '../types';\r\nimport { getModelRouter } from '../models';\r\n\r\n// ============================================================================\r\n// Guardrail Result Types\r\n// ============================================================================\r\n\r\nexport interface GuardrailCheckResult {\r\n  passed: boolean;\r\n  confidence: number; // 0-1\r\n  reason?: string;\r\n  suggestion?: string;\r\n}\r\n\r\n// ============================================================================\r\n// Safety Check\r\n// ============================================================================\r\n\r\n/**\r\n * Safety check patterns - potentially harmful advice indicators\r\n */\r\nconst HARMFUL_PATTERNS = [\r\n  /ignore.*safety/gi,\r\n  /skip.*check/gi,\r\n  /don't.*worry.*about/gi,\r\n  /not.*necessary.*to.*report/gi,\r\n  /just.*ignore.*it/gi,\r\n  /no.*need.*to.*tell.*anyone/gi,\r\n  /keep.*it.*secret.*from.*hse/gi,\r\n  /don't.*bother.*reporting/gi,\r\n  /safety.*rules.*don't.*apply/gi,\r\n  /you.*can.*skip.*this/gi,\r\n];\r\n\r\n/**\r\n * Safety check prompt for LLM-based evaluation\r\n */\r\nconst SAFETY_CHECK_PROMPT = `You are a SAFETY REVIEWER for a school compliance AI.\r\n\r\nYour role is to check if a response contains ANY advice that could:\r\n- Endanger students, staff, or visitors\r\n- Violate health and safety laws\r\n- Lead to non-compliance with statutory requirements\r\n- Compromise safeguarding\r\n\r\nEvaluate the response and respond with ONLY:\r\n- \"PASS\" if the response is safe\r\n- \"FAIL: [reason]\" if it contains potentially harmful advice\r\n\r\nBe cautious - if in doubt, FAIL.`;\r\n\r\n/**\r\n * Check if response contains harmful advice\r\n */\r\nexport async function safetyCheck(\r\n  response: string,\r\n  context?: AppContext\r\n): Promise<GuardrailCheckResult> {\r\n  // Fast pattern-based check first\r\n  for (const pattern of HARMFUL_PATTERNS) {\r\n    if (pattern.test(response)) {\r\n      return {\r\n        passed: false,\r\n        confidence: 0.9,\r\n        reason: `Response may contain unsafe advice (matched pattern: ${pattern.source})`,\r\n        suggestion: 'Please review this guidance for safety concerns before following it.',\r\n      };\r\n    }\r\n  }\r\n\r\n  // LLM-based deep check for ambiguous cases\r\n  try {\r\n    const router = getModelRouter();\r\n    const llmCheck = await router.chat(\r\n      SAFETY_CHECK_PROMPT,\r\n      `**Response to check:**\\n\\n${response}`,\r\n      {\r\n        model: 'openai/gpt-4o-mini',\r\n        temperature: 0.1,\r\n        maxTokens: 50,\r\n      }\r\n    );\r\n\r\n    const result = llmCheck.content.trim().toUpperCase();\r\n\r\n    if (result.startsWith('FAIL')) {\r\n      return {\r\n        passed: false,\r\n        confidence: 0.8,\r\n        reason: result.substring(5).trim() || 'LLM safety check failed',\r\n        suggestion: 'This response may need review. Please verify guidance with official sources.',\r\n      };\r\n    }\r\n\r\n    return { passed: true, confidence: 0.9 };\r\n  } catch {\r\n    // If LLM check fails, assume safe (pattern check already passed)\r\n    return { passed: true, confidence: 0.7 };\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Compliance Check\r\n// ============================================================================\r\n\r\n/**\r\n * Compliance uncertainty indicators\r\n */\r\nconst COMPLIANCE_UNCERTAINTY = [\r\n  /may have changed/gi,\r\n  /check.*current.*guidance/gi,\r\n  /not.*verified.*recently/gi,\r\n  /guidance.*may.*vary/gi,\r\n  /recommend.*verification/gi,\r\n  /as far as I know/gi,\r\n  /to the best of my knowledge/gi,\r\n];\r\n\r\n/**\r\n * Compliance check prompt for LLM-based evaluation\r\n */\r\nconst COMPLIANCE_CHECK_PROMPT = `You are a COMPLIANCE REVIEWER for UK schools.\r\n\r\nCheck if the response contains current, accurate statutory guidance. UK schools must follow:\r\n- HSE regulations (RIDDOR, fire safety, legionella, etc.)\r\n- DfE guidance\r\n- Ofsted requirements\r\n- Current legislation (2024-2025)\r\n\r\nRespond with ONLY:\r\n- \"PASS\" if guidance appears current\r\n- \"REVIEW: [reason]\" if guidance may be outdated or needs verification`;\r\n\r\n/**\r\n * Check if guidance is compliant and current\r\n */\r\nexport async function complianceCheck(\r\n  response: string,\r\n  context?: AppContext\r\n): Promise<GuardrailCheckResult> {\r\n  // Pattern-based check for uncertainty indicators\r\n  for (const pattern of COMPLIANCE_UNCERTAINTY) {\r\n    if (pattern.test(response)) {\r\n      return {\r\n        passed: true, // Still pass, but with warning\r\n        confidence: 0.6,\r\n        reason: 'Response indicates guidance may need verification',\r\n        suggestion: 'Please verify this guidance is current before acting on it.',\r\n      };\r\n    }\r\n  }\r\n\r\n  // Check if response has source citation (good sign for compliance)\r\n  const hasSource = response.toLowerCase().includes('source:') ||\r\n                    response.toLowerCase().includes('source:') ||\r\n                    response.toLowerCase().includes('hse.gov.uk') ||\r\n                    response.toLowerCase().includes('gov.uk');\r\n\r\n  if (!hasSource) {\r\n    return {\r\n      passed: true,\r\n      confidence: 0.7,\r\n      reason: 'No source citation provided',\r\n      suggestion: 'Guidance would be more reliable with source citation.',\r\n    };\r\n  }\r\n\r\n  return { passed: true, confidence: 0.9 };\r\n}\r\n\r\n// ============================================================================\r\n// Confidence Check\r\n// ============================================================================\r\n\r\n/**\r\n * Check knowledge confidence based on response characteristics\r\n */\r\nexport async function confidenceCheck(\r\n  response: string,\r\n  context?: AppContext\r\n): Promise<GuardrailCheckResult & { confidence: 'HIGH' | 'MEDIUM' | 'LOW' }> {\r\n  let score = 0;\r\n\r\n  // Has source citation (+2)\r\n  if (response.toLowerCase().includes('source:') ||\r\n      response.toLowerCase().includes('hse') ||\r\n      response.toLowerCase().includes('gov.uk')) {\r\n    score += 2;\r\n  }\r\n\r\n  // Has date/freshness info (+1)\r\n  if (response.toLowerCase().includes('last updated') ||\r\n      response.toLowerCase().includes('2024') ||\r\n      response.toLowerCase().includes('2025')) {\r\n    score += 1;\r\n  }\r\n\r\n  // Has uncertainty indicators (-2)\r\n  for (const pattern of COMPLIANCE_UNCERTAINTY) {\r\n    if (pattern.test(response)) {\r\n      score -= 2;\r\n      break;\r\n    }\r\n  }\r\n\r\n  // Specific and actionable (+1)\r\n  if (response.includes('###') || response.includes('1.') || response.includes('-')) {\r\n    score += 1;\r\n  }\r\n\r\n  // Very brief responses are lower confidence\r\n  if (response.length < 200) {\r\n    score -= 1;\r\n  }\r\n\r\n  // Determine confidence level\r\n  let confidence: 'HIGH' | 'MEDIUM' | 'LOW';\r\n  if (score >= 3) {\r\n    confidence = 'HIGH';\r\n  } else if (score >= 1) {\r\n    confidence = 'MEDIUM';\r\n  } else {\r\n    confidence = 'LOW';\r\n  }\r\n\r\n  return {\r\n    passed: true, // Confidence check never blocks\r\n    confidence,\r\n    reason: `Confidence score: ${score}/5`,\r\n    suggestion: confidence === 'LOW' ? 'Please verify this guidance for critical matters.' : undefined,\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Tone Check\r\n// ============================================================================\r\n\r\n/**\r\n * Tone issues to detect\r\n */\r\nconst TONE_ISSUES = [\r\n  { pattern: /stupid|idiotic|dumb|idiot|moron/gi, issue: 'Inappropriate language' },\r\n  { pattern: /whatever|doesn't matter|who cares/gi, issue: 'Dismissive tone' },\r\n  { pattern: /i don't care|not my problem/gi, issue: 'Unhelpful attitude' },\r\n  { pattern: /obviously|clearly.*you should.*know/gi, issue: 'Condescending tone' },\r\n  { pattern: /just.*do.*it|stop.*asking/gi, issue: 'Impatient tone' },\r\n];\r\n\r\n/**\r\n * Tone check prompt for LLM-based evaluation\r\n */\r\nconst TONE_CHECK_PROMPT = `You are a TONE REVIEWER for Schoolgle, a helpful school assistant.\r\n\r\nEd's tone should be:\r\n- Warm and supportive\r\n- Professional and respectful\r\n- Clear and concise\r\n- Empathetic to busy school staff\r\n\r\nCheck if the response has appropriate tone. Respond with ONLY:\r\n- \"PASS\" if tone is appropriate\r\n- \"FAIL: [reason]\" if tone is inappropriate (too informal, rude, dismissive, etc.)`;\r\n\r\n/**\r\n * Check if response has appropriate tone\r\n */\r\nexport async function toneCheck(\r\n  response: string,\r\n  context?: AppContext\r\n): Promise<GuardrailCheckResult> {\r\n  // Fast pattern-based check\r\n  for (const { pattern, issue } of TONE_ISSUES) {\r\n    if (pattern.test(response)) {\r\n      return {\r\n        passed: false,\r\n        confidence: 0.9,\r\n        reason: `Tone issue: ${issue}`,\r\n        suggestion: 'The response should be rephrased in a more professional, supportive manner.',\r\n      };\r\n    }\r\n  }\r\n\r\n  // LLM-based tone check for subtler issues\r\n  try {\r\n    const router = getModelRouter();\r\n    const llmCheck = await router.chat(\r\n      TONE_CHECK_PROMPT,\r\n      `**Response to check:**\\n\\n${response}`,\r\n      {\r\n        model: 'openai/gpt-4o-mini',\r\n        temperature: 0.1,\r\n        maxTokens: 50,\r\n      }\r\n    );\r\n\r\n    const result = llmCheck.content.trim().toUpperCase();\r\n\r\n    if (result.startsWith('FAIL')) {\r\n      return {\r\n        passed: false,\r\n        confidence: 0.7,\r\n        reason: result.substring(5).trim() || 'Tone check failed',\r\n        suggestion: 'Response tone should be adjusted to be more supportive and professional.',\r\n      };\r\n    }\r\n\r\n    return { passed: true, confidence: 0.9 };\r\n  } catch {\r\n    return { passed: true, confidence: 0.7 };\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Permission Check\r\n// ============================================================================\r\n\r\n/**\r\n * Check if user has permission for this information\r\n */\r\nexport async function permissionCheck(\r\n  response: string,\r\n  context: AppContext\r\n): Promise<GuardrailCheckResult> {\r\n  const { userRole, subscription, activeApp } = context;\r\n\r\n  // Viewer role gets limited access\r\n  if (userRole === 'viewer') {\r\n    // Check for restricted content\r\n    const restrictedKeywords = [\r\n      'salary details',\r\n      'contract details',\r\n      'confidential information',\r\n      'sensitive information',\r\n      'staff personal data',\r\n    ];\r\n\r\n    for (const keyword of restrictedKeywords) {\r\n      if (response.toLowerCase().includes(keyword)) {\r\n        return {\r\n          passed: false,\r\n          confidence: 0.95,\r\n          reason: 'Content requires higher permissions',\r\n          suggestion: 'You do not have permission to view this information. Please contact your administrator.',\r\n        };\r\n      }\r\n    }\r\n  }\r\n\r\n  // Check feature access based on subscription\r\n  if (subscription.plan === 'free') {\r\n    const paidFeatures = ['estates', 'hr', 'send', 'data', 'curriculum', 'procurement', 'governance'];\r\n    // This would be set by the agent-router earlier, but we double-check\r\n    // If response contains detailed specialist advice, flag it\r\n  }\r\n\r\n  return { passed: true, confidence: 1.0 };\r\n}\r\n\r\n// ============================================================================\r\n// Source Requirement\r\n// ============================================================================\r\n\r\n/**\r\n * Ensure source citation is included\r\n */\r\nexport function ensureSourceCitation(\r\n  response: string,\r\n  domain?: string\r\n): string {\r\n  // Check if source already cited\r\n  const hasSource = response.toLowerCase().includes('source:') ||\r\n                    response.toLowerCase().includes('source:') ||\r\n                    response.toLowerCase().includes('**source**') ||\r\n                    response.toLowerCase().includes('*source*');\r\n\r\n  if (hasSource) {\r\n    return response;\r\n  }\r\n\r\n  // Add generic source citation\r\n  const domainSources: Record<string, string> = {\r\n    estates: 'HSE',\r\n    hr: 'ACAS / Gov.uk',\r\n    send: 'SEND Code of Practice',\r\n    data: 'DfE',\r\n    curriculum: 'DfE / Ofsted',\r\n    'it-tech': 'DfE / vendor documentation',\r\n    procurement: 'CIPS / Gov.uk',\r\n    governance: 'DfE / NGA',\r\n    communications: 'CIPR / Gov.uk',\r\n  };\r\n\r\n  const sourceName = domain ? domainSources[domain] || 'Schoolgle Knowledge Base' : 'Schoolgle Knowledge Base';\r\n\r\n  return `${response}\r\n\r\n---\r\n\r\n*Source: ${sourceName} | Confidence: Medium | Please verify for critical matters*`;\r\n}\r\n\r\n// ============================================================================\r\n// Full Pipeline\r\n// ============================================================================\r\n\r\n/**\r\n * Apply all guardrails to a response\r\n */\r\nexport async function applyGuardrails(\r\n  response: string,\r\n  context: AppContext,\r\n  domain?: string\r\n): Promise<GuardrailResult> {\r\n  // Run all checks in parallel where possible\r\n  const [\r\n    safety,\r\n    compliance,\r\n    tone,\r\n    permission,\r\n  ] = await Promise.all([\r\n    safetyCheck(response, context),\r\n    complianceCheck(response, context),\r\n    toneCheck(response, context),\r\n    permissionCheck(response, context),\r\n  ]);\r\n\r\n  // Confidence check is synchronous\r\n  const confidenceResult = await confidenceCheck(response, context);\r\n\r\n  // 1. Safety check - most critical, fail fast\r\n  if (!safety.passed && safety.confidence > 0.7) {\r\n    return {\r\n      passed: false,\r\n      requiresHuman: true,\r\n      reason: safety.reason,\r\n      response: formatWithWarning(response, SAFETY_WARNING, safety.suggestion),\r\n    };\r\n  }\r\n\r\n  // 2. Tone check - must be professional\r\n  if (!tone.passed && tone.confidence > 0.7) {\r\n    return {\r\n      passed: true,\r\n      warning: 'Tone adjustment recommended',\r\n      response: await adjustTone(response, tone.reason),\r\n    };\r\n  }\r\n\r\n  // 3. Permission check - access control\r\n  if (!permission.passed) {\r\n    return {\r\n      passed: false,\r\n      response: permission.suggestion || \"I don't have access to that information. Please contact your administrator.\",\r\n      reason: permission.reason,\r\n    };\r\n  }\r\n\r\n  // 4. Build final response with warnings and sources\r\n  let finalResponse = response;\r\n  const warnings: string[] = [];\r\n\r\n  // Add compliance warning if needed\r\n  if (compliance.reason && compliance.confidence < 0.7) {\r\n    warnings.push(compliance.suggestion || 'Please verify this guidance is current.');\r\n  }\r\n\r\n  // Add confidence warning if low\r\n  if (confidenceResult.confidence === 'LOW') {\r\n    warnings.push('Low confidence - please verify for critical matters.');\r\n  }\r\n\r\n  // 5. Ensure source citation\r\n  finalResponse = ensureSourceCitation(finalResponse, domain);\r\n\r\n  // 6. Add warnings if present\r\n  if (warnings.length > 0) {\r\n    finalResponse = `${finalResponse}\\n\\n⚠️ **Note:** ${warnings.join(' ')}`;\r\n  }\r\n\r\n  return {\r\n    passed: true,\r\n    response: finalResponse,\r\n    warning: warnings.length > 0 ? warnings.join(' ') : undefined,\r\n    metadata: {\r\n      safetyPassed: safety.passed,\r\n      confidenceLevel: confidenceResult.confidence,\r\n      hasSource: finalResponse.toLowerCase().includes('source'),\r\n    },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Warning Messages\r\n// ============================================================================\r\n\r\nconst SAFETY_WARNING = `\r\n⚠️ **Safety Warning:** This response has been flagged for potential safety concerns.\r\n\r\n**Please do not act on this advice without:**\r\n1. Verifying with official sources (HSE, DfE, etc.)\r\n2. Consulting with appropriate qualified staff\r\n3. Checking your school's specific policies\r\n\r\nIf this is a safety-critical matter, please seek professional advice immediately.`;\r\n\r\n/**\r\n * Format response with warning\r\n */\r\nfunction formatWithWarning(\r\n  response: string,\r\n  warning: string,\r\n  suggestion?: string\r\n): string {\r\n  return `${response}\r\n\r\n${warning}\r\n\r\n${suggestion ? `**Suggestion:** ${suggestion}` : ''}`;\r\n}\r\n\r\n/**\r\n * Adjust tone of response (placeholder - would use LLM in production)\r\n */\r\nasync function adjustTone(response: string, reason?: string): Promise<string> {\r\n  // In production, would use LLM to rephrase\r\n  // For now, return as-is with note\r\n  return `${response}\r\n\r\n*(Note: This response may need tone adjustment - ${reason || 'be more professional'})*`;\r\n}\r\n"],"mappings":"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","names":[]}