{"version":3,"sources":["../src/perspectives/generator.ts"],"sourcesContent":["/**\r\n * Multi-Perspective Generator\r\n * Generates optimist, critic, and neutral perspectives for balanced responses\r\n */\r\n\r\nimport type { PerspectiveType, PerspectiveResponse, AppContext } from '../types';\r\nimport { getModelRouter } from '../models';\r\n\r\n// ============================================================================\r\n// Perspective Prompts\r\n// ============================================================================\r\n\r\n/**\r\n * Optimist perspective prompt\r\n */\r\nexport const OPTIMIST_PROMPT = `You are the OPTIMIST perspective.\r\n\r\nYour role is to highlight:\r\n- What's working well\r\n- What's possible\r\n- Positive outcomes\r\n- Encouraging aspects\r\n- Benefits and opportunities\r\n\r\nKeep it brief (2-3 sentences max). Focus on possibilities and what could go right.\r\n\r\n**Important:** Be specific to the question asked, not generic positivity.`;\r\n\r\n/**\r\n * Critic perspective prompt\r\n */\r\nexport const CRITIC_PROMPT = `You are the CRITIC perspective (devil's advocate).\r\n\r\nYour role is to highlight:\r\n- What could go wrong\r\n- Risks and concerns\r\n- Missing information\r\n- Areas that need caution\r\n- Potential pitfalls\r\n\r\nKeep it brief (2-3 sentences max). Focus on safety and what could go wrong.\r\n\r\n**Important:** Be specific to the question asked, not generic negativity.`;\r\n\r\n/**\r\n * Neutral perspective prompt\r\n */\r\nexport const NEUTRAL_PROMPT = `You are the NEUTRAL perspective.\r\n\r\nYour role is to provide:\r\n- Balanced factual summary\r\n- Key points only\r\n- No bias either way\r\n- Objective assessment\r\n\r\nKeep it brief (2-3 sentences max). Focus on facts.\r\n\r\n**Important:** Be specific to the question asked, avoid vague statements.`;\r\n\r\n/**\r\n * Synthesis prompt\r\n */\r\nexport const SYNTHESIS_PROMPT = `You are a SYNTHESIZER.\r\n\r\nYour role is to combine three perspectives into a balanced, actionable response.\r\n\r\nYou will receive:\r\n1. The original question\r\n2. An expert's answer\r\n3. Three perspectives: optimist, critic, and neutral\r\n\r\nCreate a response that:\r\n- Acknowledges the expert guidance\r\n- Incorporates valid points from all perspectives\r\n- Provides a balanced view of the situation\r\n- Ends with clear, actionable next steps\r\n\r\nBe concise but comprehensive. Use markdown formatting for readability.`;\r\n\r\n// ============================================================================\r\n// Perspective Generation\r\n// ============================================================================\r\n\r\n/**\r\n * Generate multi-perspective response\r\n */\r\nexport async function generateMultiPerspectiveResponse(\r\n  question: string,\r\n  specialistResponse: string,\r\n  context: AppContext\r\n): Promise<{\r\n  synthesized: string;\r\n  perspectives: {\r\n    optimist?: string;\r\n    critic?: string;\r\n    neutral?: string;\r\n  };\r\n}> {\r\n  // Use cheaper model for perspectives (they're shorter, less critical)\r\n  const perspectiveModelId = 'deepseek/deepseek-chat';\r\n  const synthesisModelId = 'anthropic/claude-3.5-sonnet';\r\n\r\n  try {\r\n    // Generate three perspectives in parallel\r\n    const [optimist, critic, neutral] = await Promise.all([\r\n      generatePerspective(question, specialistResponse, 'optimist', context, perspectiveModelId),\r\n      generatePerspective(question, specialistResponse, 'critic', context, perspectiveModelId),\r\n      generatePerspective(question, specialistResponse, 'neutral', context, perspectiveModelId),\r\n    ]);\r\n\r\n    // Synthesize into balanced response\r\n    const synthesized = await synthesizeResponse(question, specialistResponse, {\r\n      optimist,\r\n      critic,\r\n      neutral,\r\n    }, context, synthesisModelId);\r\n\r\n    return {\r\n      synthesized,\r\n      perspectives: {\r\n        optimist,\r\n        critic,\r\n        neutral,\r\n      },\r\n    };\r\n  } catch (error) {\r\n    // If perspective generation fails, return specialist response with warning\r\n    console.error('Perspective generation failed:', error);\r\n    return {\r\n      synthesized: `${specialistResponse}\\n\\n*Note: Unable to generate additional perspectives at this time.*`,\r\n      perspectives: undefined,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Generate a single perspective\r\n */\r\nasync function generatePerspective(\r\n  question: string,\r\n  specialistResponse: string,\r\n  type: PerspectiveType,\r\n  context: AppContext,\r\n  modelId: string\r\n): Promise<string> {\r\n  const router = getModelRouter();\r\n  const prompt = getPerspectivePrompt(type);\r\n\r\n  const userMessage = `\r\n**Question:** ${question}\r\n\r\n**Specialist Response:** ${specialistResponse}\r\n\r\nProvide your ${type} perspective on this guidance.`;\r\n\r\n  try {\r\n    const response = await router.chat(\r\n      prompt,\r\n      userMessage,\r\n      {\r\n        model: modelId,\r\n        temperature: 0.7,\r\n        maxTokens: 200, // Perspectives should be brief\r\n      }\r\n    );\r\n\r\n    return response.content.trim();\r\n  } catch (error) {\r\n    // Return fallback if generation fails\r\n    return getFallbackPerspective(type, question);\r\n  }\r\n}\r\n\r\n/**\r\n * Get perspective prompt by type\r\n */\r\nfunction getPerspectivePrompt(type: PerspectiveType): string {\r\n  switch (type) {\r\n    case 'optimist':\r\n      return OPTIMIST_PROMPT;\r\n    case 'critic':\r\n      return CRITIC_PROMPT;\r\n    case 'neutral':\r\n      return NEUTRAL_PROMPT;\r\n  }\r\n}\r\n\r\n/**\r\n * Synthesize multiple perspectives into final response\r\n */\r\nasync function synthesizeResponse(\r\n  question: string,\r\n  specialistResponse: string,\r\n  perspectives: {\r\n    optimist: string;\r\n    critic: string;\r\n    neutral: string;\r\n  },\r\n  context: AppContext,\r\n  modelId: string\r\n): Promise<string> {\r\n  const router = getModelRouter();\r\n\r\n  const userMessage = `\r\n**Question:** ${question}\r\n\r\n**Specialist Response:**\r\n${specialistResponse}\r\n\r\n**Perspectives:**\r\n\r\n**Optimist says:**\r\n${perspectives.optimist}\r\n\r\n**Critic says:**\r\n${perspectives.critic}\r\n\r\n**Neutral says:**\r\n${perspectives.neutral}\r\n\r\nPlease synthesize this into a balanced, actionable response.`;\r\n\r\n  try {\r\n    const response = await router.chat(\r\n      SYNTHESIS_PROMPT,\r\n      userMessage,\r\n      {\r\n        model: modelId,\r\n        temperature: 0.7,\r\n        maxTokens: 1000,\r\n      }\r\n    );\r\n\r\n    return response.content.trim();\r\n  } catch (error) {\r\n    // Fallback to simple format if synthesis fails\r\n    return formatFallbackSynthesis(specialistResponse, perspectives);\r\n  }\r\n}\r\n\r\n/**\r\n * Get fallback perspective when generation fails\r\n */\r\nfunction getFallbackPerspective(type: PerspectiveType, question: string): string {\r\n  switch (type) {\r\n    case 'optimist':\r\n      return \"From a positive perspective, this is a solvable challenge with clear steps forward. Following the guidance should lead to successful outcomes.\";\r\n    case 'critic':\r\n      return \"From a cautious perspective, ensure you verify all guidance is current and follow procedures carefully. Don't cut corners on safety or compliance.\";\r\n    case 'neutral':\r\n      return \"From a balanced perspective, follow the established procedures and verify guidance for your specific situation.\";\r\n  }\r\n}\r\n\r\n/**\r\n * Format fallback synthesis when LLM fails\r\n */\r\nfunction formatFallbackSynthesis(\r\n  specialistResponse: string,\r\n  perspectives: {\r\n    optimist: string;\r\n    critic: string;\r\n    neutral: string;\r\n  }\r\n): string {\r\n  return `${specialistResponse}\r\n\r\n---\r\n\r\n### Additional Perspectives\r\n\r\n**Optimistic View:**\r\n${perspectives.optimist}\r\n\r\n**Cautious View:**\r\n${perspectives.critic}\r\n\r\n**Balanced View:**\r\n${perspectives.neutral}`;\r\n}\r\n\r\n// ============================================================================\r\n// Perspective Caching\r\n// ============================================================================\r\n\r\n/**\r\n * Simple in-memory cache for perspectives (to reduce API calls)\r\n */\r\nconst perspectiveCache = new Map<string, {\r\n  perspectives: PerspectiveResponse;\r\n  timestamp: number;\r\n}>();\r\n\r\nconst CACHE_TTL = 1000 * 60 * 60; // 1 hour\r\n\r\n/**\r\n * Generate perspectives with caching\r\n */\r\nexport async function generatePerspectivesCached(\r\n  question: string,\r\n  specialistResponse: string,\r\n  context: AppContext\r\n): Promise<{\r\n  synthesized: string;\r\n  perspectives: {\r\n    optimist?: string;\r\n    critic?: string;\r\n    neutral?: string;\r\n  };\r\n}> {\r\n  const cacheKey = `${question}:${specialistResponse.substring(0, 100)}`;\r\n  const cached = perspectiveCache.get(cacheKey);\r\n\r\n  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\r\n    return cached.perspectives as any;\r\n  }\r\n\r\n  const result = await generateMultiPerspectiveResponse(question, specialistResponse, context);\r\n\r\n  perspectiveCache.set(cacheKey, {\r\n    perspectives: result as any,\r\n    timestamp: Date.now(),\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Clear perspective cache\r\n */\r\nexport function clearPerspectiveCache(): void {\r\n  perspectiveCache.clear();\r\n}\r\n"],"mappings":"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","names":[]}