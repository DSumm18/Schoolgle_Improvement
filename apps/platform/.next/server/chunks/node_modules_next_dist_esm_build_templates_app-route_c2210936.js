module.exports=[14009,e=>{"use strict";var t=e.i(47909),o=e.i(74017),r=e.i(96250),a=e.i(59756),n=e.i(61916),s=e.i(14444),i=e.i(10680),l=e.i(69741),c=e.i(16795),d=e.i(87718),u=e.i(95169),p=e.i(47587),h=e.i(66012),m=e.i(70101),g=e.i(26937),f=e.i(10372),y=e.i(93695);e.i(52474);var v=e.i(220),E=e.i(89171);class R{constructor(e){if(this.baseUrl="https://openrouter.ai/api/v1",!e)throw Error("OpenRouter API key is required");this.apiKey=e}async chatCompletion(e){try{let t=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","HTTP-Referer":"https://schoolgle.co.uk","X-Title":"Schoolgle Ed AI"},body:JSON.stringify({model:e.model,messages:e.messages.map(e=>({role:e.role,content:e.content})),temperature:e.temperature??.7,max_tokens:e.maxTokens??1e3,top_p:e.topP??1})});if(!t.ok){let e=await t.text();throw Error(`OpenRouter API error: ${t.status} - ${e}`)}let o=await t.json();return{id:o.id,choices:o.choices.map(e=>({message:{role:e.message.role,content:e.message.content},finishReason:e.finish_reason})),usage:{promptTokens:o.usage?.prompt_tokens||0,completionTokens:o.usage?.completion_tokens||0,totalTokens:o.usage?.total_tokens||0},model:o.model}}catch(e){throw console.error("OpenRouter API Error:",e),e}}async testConnection(){try{let e=await this.chatCompletion({model:"google/gemini-2.0-flash-lite:free",messages:[{role:"user",content:"Hello"}],maxTokens:10});return!!e.choices[0]?.message?.content}catch(e){return console.error("Connection test failed:",e),!1}}}let T=new class{estimateTokens(e){return Math.ceil(e.length/4)}analyzeTaskComplexity(e){let t=e[e.length-1],o=this.estimateTokens(t.content);return{tokenCount:o,requiresReasoning:["explain","analyze","compare","evaluate","plan","strategy"].some(e=>t.content.toLowerCase().includes(e)),requiresVision:!1}}determineTaskType(e,t){if(t?.screenshot)return"vision_analysis";if(t?.taskType==="document_extract")return"ocr";if(t?.taskType==="generate_report")return"report_generation";let{tokenCount:o,requiresReasoning:r}=this.analyzeTaskComplexity(e);return o>500||r?"chat_complex":"chat_simple"}route(e,t={}){let o,r,a,n=this.determineTaskType(e,t);switch(n){case"vision_analysis":o={model:"qwen/qwen-2.5-vl-72b",provider:"openrouter",maxTokens:1500,temperature:.3},r="UI screenshot analysis requires vision model",a=8e-4;break;case"ocr":o={model:"mistralai/pixtral-large-2411",provider:"openrouter",maxTokens:2e3,temperature:.1},r="OCR task requires specialized model",a=4e-4;break;case"report_generation":o={model:"openai/gpt-4o-mini",provider:"openrouter",maxTokens:4e3,temperature:.7},r="Report writing benefits from GPT-4o-mini quality",a=.002;break;case"chat_complex":o={model:"deepseek/deepseek-chat",provider:"openrouter",maxTokens:2e3,temperature:.7},r="Complex reasoning task, using DeepSeek V3",a=.0012;break;default:o={model:"google/gemini-2.0-flash-lite:free",provider:"openrouter",maxTokens:1e3,temperature:.7},r="Simple query, using fast & cheap model",a=15e-5}return{taskType:n,selectedModel:o,reason:r,estimatedCost:a}}};class C{constructor(e){this.openRouter=new R(e)}async handleChat(e){try{var t;let o,r=T.route(e.messages,e.context);console.log("[Ed] Routing decision:",{taskType:r.taskType,model:r.selectedModel.model,reason:r.reason});let a=(t=e.context,o=`You are Ed, an AI school assistant created by Schoolgle.

PERSONALITY:
- Warm, supportive, and honest - like a trusted colleague
- Practical and action-oriented, not theoretical
- Use UK education terminology
- Acknowledge pressures on school staff
- Light humour is welcome but stay professional

EXPERTISE:
- Ofsted Education Inspection Framework (November 2025)
- SIAMS framework (for church schools)
- EEF Teaching & Learning Toolkit
- School improvement and self-evaluation
- UK school operations and compliance`,"schoolgle-platform"===t.product?o+`

CURRENT CONTEXT:
School: ${t.schoolName}
${t.schoolType?`Type: ${t.schoolType}`:""}
${t.isChurchSchool?"This is a church school (both Ofsted and SIAMS apply)":""}
${t.page?`Current page: ${t.page}`:""}
${t.category?`Focus area: ${t.category}`:""}

${function(e){if(!e.schoolgleContext)return"";let t=[];if(void 0!==e.schoolgleContext.healthScore){let o=e.schoolgleContext.healthScore,r="good";o<40?r="critical":o<60?r="at risk":o<75&&(r="neutral"),t.push(`School improvement health: ${o}/100 (${r})`)}if(e.schoolgleContext.gaps&&e.schoolgleContext.gaps.length>0&&(t.push(`
EVIDENCE GAPS (${e.schoolgleContext.gaps.length}):`),e.schoolgleContext.gaps.slice(0,5).forEach(e=>{t.push(`- ${e.area}/${e.subcategory}: ${e.description||"Missing evidence"} [${e.severity}]`)}),e.schoolgleContext.gaps.length>5&&t.push(`  ... and ${e.schoolgleContext.gaps.length-5} more`)),e.schoolgleContext.recentActivity&&e.schoolgleContext.recentActivity.length>0&&(t.push(`
RECENT ACTIVITY:`),e.schoolgleContext.recentActivity.slice(0,3).forEach(e=>{t.push(`- ${e.type}: ${e.summary}`)})),e.schoolgleContext.evidenceSummary){let o=e.schoolgleContext.evidenceSummary;t.push(`
EVIDENCE SUMMARY:`),t.push(`- Total documents scanned: ${o.totalDocuments}`),t.push(`- Evidence matches found: ${o.evidenceMatches}`)}return t.length>0?"\n"+t.join("\n"):""}(t)}

GUIDELINES:
- Always cite EEF research when making recommendations
- Link advice to specific Ofsted framework requirements
- Be specific and actionable (not generic advice)
- If you see evidence gaps, proactively suggest how to fill them
- If actions are overdue, gently remind without being pushy
- Celebrate progress and strengths`:"parent-chat"===t.product?o+`

CURRENT CONTEXT:
School: ${t.schoolName}

GUIDELINES FOR PARENT QUERIES:
- Be friendly and welcoming
- Provide accurate school information
- If you don't know something, say so clearly
- Direct parents to contact school for specific queries
- Never make up information about the school`:"staff-tools"===t.product?o+`

CURRENT CONTEXT:
Helping with: ${t.page||"MIS system navigation"}
${t.screenshot?"Analyzing screenshot of school system":""}

GUIDELINES FOR STAFF SUPPORT:
- Provide step-by-step instructions
- Be patient and clear
- Explain why each step matters
- Offer shortcuts and tips
- If stuck, suggest contacting system support`:o),n=[{role:"system",content:a},...e.messages],s=await this.openRouter.chatCompletion({model:r.selectedModel.model,messages:n,temperature:r.selectedModel.temperature,maxTokens:r.selectedModel.maxTokens,topP:r.selectedModel.topP});return{message:s.choices[0]?.message?.content||"",conversationId:e.context.conversationId||s.id,model:s.model,usage:{tokens:s.usage.totalTokens,cost:r.estimatedCost}}}catch(e){throw console.error("[Ed] Chat error:",e),Error(`Ed chat failed: ${e instanceof Error?e.message:"Unknown error"}`)}}}async function w(e){try{let t=process.env.VITE_OPENROUTER_API_KEY||process.env.OPENAI_API_KEY;if(!t)return E.NextResponse.json({error:"AI API key not configured"},{status:500});let{messages:o,context:r}=await e.json();if(!o||!Array.isArray(o))return E.NextResponse.json({error:"Invalid messages format"},{status:400});let a={organizationId:r.organizationId||"demo",schoolName:r.schoolName||"Demo School",product:"schoolgle-platform",page:r.page,category:r.category,userId:r.userId,userRole:r.userRole,conversationId:r.conversationId,schoolgleContext:r.schoolgleContext||{assessments:[],gaps:[],recentActivity:[],healthScore:void 0,evidenceSummary:void 0}},n=new C(t),s=await n.handleChat({messages:o,context:a});return E.NextResponse.json({response:s.message,message:s.message,conversationId:s.conversationId,metadata:{model:s.model,tokens:s.usage.tokens,cost:s.usage.cost}})}catch(e){return console.error("[Ed API] Error:",e),E.NextResponse.json({response:`I'm having a bit of trouble connecting right now. Let me give you a quick answer based on what I know...

I'm Ed, your AI School Improvement Partner. I can help you with:

ðŸ“š **Understanding Ofsted** - What inspectors look for
ðŸ”¬ **EEF Research** - Evidence-based strategies
ðŸ“Š **Data Analysis** - Making sense of patterns
ðŸŽ¯ **Action Planning** - Creating improvement actions

What would you like to explore?`,error:e instanceof Error?e.message:"Unknown error"})}}e.s(["POST",()=>w],79014);var x=e.i(79014);let k=new t.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/ed/chat/route",pathname:"/api/ed/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/platform/src/app/api/ed/chat/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:I,workUnitAsyncStorage:A,serverHooks:S}=k;function N(){return(0,r.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:A})}async function P(e,t,r){k.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/ed/chat/route";E=E.replace(/\/index$/,"")||"/";let R=await k.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:T,params:C,nextConfig:w,parsedUrl:x,isDraftMode:I,prerenderManifest:A,routerServerContext:S,isOnDemandRevalidate:N,revalidateOnlyGenerated:P,resolvedPathname:b,clientReferenceManifest:O,serverActionsManifest:_}=R,$=(0,l.normalizeAppPath)(E),U=!!(A.dynamicRoutes[$]||A.routes[b]),M=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,x,!1):t.end("This page could not be found"),null);if(U&&!I){let e=!!A.routes[b],t=A.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await M();throw new y.NoFallbackError}}let q=null;!U||k.isDev||I||(q="/index"===(q=b)?"/":q);let D=!0===k.isDev||!U,H=U&&!D;_&&O&&(0,s.setReferenceManifestsSingleton)({page:E,clientReferenceManifest:O,serverActionsManifest:_,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:_})});let F=e.method||"GET",j=(0,n.getTracer)(),K=j.getActiveScopeSpan(),L={params:C,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,o,r)=>k.onRequestError(e,t,r,S)},sharedContext:{buildId:T}},z=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest(z,(0,d.signalFromNodeResponse)(t));try{let s=async e=>k.handle(V,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let o=j.getRootSpanAttributes();if(!o)return;if(o.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${o.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=o.get("next.route");if(r){let t=`${F} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${E}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var n,l;let c=async({previousCacheEntry:o})=>{try{if(!i&&N&&P&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=L.renderOpts.collectedTags;if(!U)return await (0,h.sendResponse)(z,B,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let o=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,r=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:o,expire:r}}}}catch(t){throw(null==o?void 0:o.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},S),t}},d=await k.handleResponse({req:e,nextConfig:w,cacheKey:q,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:P,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:i});if(!U)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",N?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&U||u.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(z,B,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};K?await l(K):await j.withPropagatedContext(e.headers,()=>j.trace(u.BaseServerSpan.handleRequest,{spanName:`${F} ${E}`,kind:n.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})}),U)throw t;return await (0,h.sendResponse)(z,B,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>N,"routeModule",()=>k,"serverHooks",()=>S,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>A],14009)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_c2210936.js.map