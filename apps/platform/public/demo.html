<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schoolgle Ed - AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow-x: hidden;
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }

        /* --- MOCK WEBSITE (ADMISSIONS) --- */
        #website-mockup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow-y: auto;
            color: #1e293b;
            scroll-behavior: smooth;
        }

        .mock-nav {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mock-hero {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 4rem 2rem;
            text-align: center;
        }

        .mock-content {
            padding: 3rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        .mock-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        /* FORM STYLES */
        .mock-form-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .mock-input-group {
            margin-bottom: 1.5rem;
            transition: all 0.3s;
            padding: 4px;
            border-radius: 8px;
        }

        .mock-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 0.5rem;
        }

        .mock-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s;
            background: white;
        }

        /* ACCESSIBILITY FOCUS GLOW */
        .field-active .mock-input {
            border-color: #2dd4bf;
            box-shadow: 0 0 0 4px rgba(45, 212, 191, 0.3);
            background-color: #f0fdfa;
        }

        .field-active .mock-label {
            color: #0d9488;
        }

        /* --- WIDGET --- */
        #ed-widget-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 400px;
            height: 600px;
            z-index: 9999;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-end;
            padding: 2rem;
        }

        #launcher-group {
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            position: absolute;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
        }

        body.widget-active #launcher-group {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        #launcher-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #0f172a;
            box-shadow: 0 10px 25px -5px rgba(15, 23, 42, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(45, 212, 191, 0.3);
        }

        #launcher-btn:hover {
            transform: scale(1.1);
        }

        .launcher-icon {
            width: 32px;
            height: 32px;
            background-image: radial-gradient(circle, #2dd4bf 1.5px, transparent 2px);
            background-size: 6px 6px;
            border-radius: 50%;
            animation: spin-slow 10s linear infinite;
        }

        @keyframes spin-slow {
            to {
                transform: rotate(360deg);
            }
        }

        .launcher-label {
            background: #0f172a;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #app-panel {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body.widget-active #app-panel {
            opacity: 1;
            visibility: visible;
        }

        #canvas-container {
            position: absolute;
            bottom: 60px;
            right: 0;
            width: 300px;
            height: 300px;
            z-index: 10;
            pointer-events: none;
        }

        /* --- DOCK (Highest Z-Index for Accessibility) --- */
        #app-dock {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20000;
            pointer-events: auto;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            padding: 12px 20px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .dock-item {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dock-item:hover {
            transform: scale(1.15) translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .dock-item svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        #dock-mic-btn {
            width: 56px;
            height: 56px;
            border-radius: 20px;
            background: linear-gradient(135deg, #2dd4bf, #0d9488);
            box-shadow: 0 4px 15px rgba(45, 212, 191, 0.4);
            margin: 0 8px;
        }

        #dock-mic-btn:hover {
            transform: scale(1.1) translateY(-5px);
        }

        #dock-mic-btn svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }

        .mic-active {
            animation: pulse-mic 1.5s infinite;
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            border-color: transparent !important;
        }

        @keyframes pulse-mic {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            100% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }
        }

        .dock-menu {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px) scale(0.9);
            margin-bottom: 15px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            width: 180px;
            transform-origin: bottom center;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
            z-index: 20001;
        }

        .dock-menu.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0) scale(1);
            pointer-events: auto;
        }

        .dock-menu::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: rgba(15, 23, 42, 0.9) transparent transparent transparent;
        }

        .carousel-scroll {
            max-height: 160px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .carousel-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .carousel-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .carousel-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .menu-opt {
            background: transparent;
            color: #cbd5e1;
            border: none;
            padding: 10px 12px;
            text-align: left;
            font-size: 0.85rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .menu-opt:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-opt.selected {
            background: rgba(45, 212, 191, 0.15);
            color: #2dd4bf;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            flex-shrink: 0;
        }

        .status-pill {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: #2dd4bf;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- CHAT --- */
        .chat-container {
            position: absolute;
            bottom: 110px;
            right: 0;
            left: 0;
            top: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding-bottom: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 15;
        }

        body.view-chat .chat-container {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .chat-scroll {
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 0 10px;
            max-height: 100%;
            mask-image: linear-gradient(to bottom, transparent, black 10%);
        }

        .msg {
            pointer-events: auto;
            padding: 10px 16px;
            border-radius: 18px;
            font-size: 0.9rem;
            line-height: 1.4;
            max-width: 90%;
            animation: popIn 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .msg-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 6px 0;
        }

        .msg-sub {
            font-size: 0.8em;
            opacity: 0.8;
            font-style: italic;
            display: block;
        }

        .theme-standard .msg-ai {
            background: rgba(15, 23, 42, 0.85);
            color: white;
            border-bottom-right-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .theme-standard .msg-user {
            background: rgba(255, 255, 255, 0.9);
            color: #0f172a;
            border-bottom-right-radius: 4px;
            margin-right: 12px;
            font-weight: 500;
        }

        .theme-warm .msg-ai {
            background: #422006;
            color: #fef08a;
            border-bottom-right-radius: 4px;
            border: 1px solid #fde047;
        }

        .theme-warm .msg-user {
            background: #fef08a;
            color: #422006;
            border-bottom-right-radius: 4px;
            margin-right: 12px;
            font-weight: 600;
        }

        .theme-cool .msg-ai {
            background: #0c4a6e;
            color: #e0f2fe;
            border-bottom-right-radius: 4px;
            border: 1px solid #38bdf8;
        }

        .theme-cool .msg-user {
            background: #e0f2fe;
            color: #0c4a6e;
            border-bottom-right-radius: 4px;
            margin-right: 12px;
            font-weight: 600;
        }

        .theme-contrast .msg-ai {
            background: black;
            color: #ffff00;
            border: 2px solid #ffff00;
            border-radius: 8px;
            font-weight: 700;
        }

        .theme-contrast .msg-user {
            background: #ffff00;
            color: black;
            border: 2px solid black;
            border-radius: 8px;
            margin-right: 12px;
            font-weight: 700;
        }

        .input-bar {
            pointer-events: auto;
            margin: 0 10px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 30px;
            padding: 6px 6px 6px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        }

        /* HELP MSG LINK */
        .help-link {
            color: #38bdf8;
            text-decoration: underline;
            font-weight: 600;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body>

    <!-- MOCK WEBSITE (ADMISSIONS) -->
    <div id="website-mockup">
        <div class="mock-nav">
            <div class="font-bold text-xl text-slate-800 flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded"></div>Greenwood High
            </div>
            <div class="space-x-6 text-sm font-medium text-slate-600">
                <span>Home</span><span>Curriculum</span><span>Staff</span><span
                    class="bg-blue-600 text-white px-4 py-2 rounded-full">Portal</span></div>
        </div>
        <div class="mock-hero">
            <h1 class="text-4xl font-bold mb-4">Admissions & Enquiries</h1>
            <p class="text-blue-100 text-lg max-w-xl mx-auto">Join our community. Please fill out the form below for
                enrollment or general questions.</p>
        </div>
        <div class="mock-content">
            <div class="col-span-1">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Get in Touch</h2>
                <p class="text-slate-600 mb-8">Our admissions team is here to help you every step of the way.</p>

                <div class="mock-form-card">
                    <div class="mock-input-group" id="group-name">
                        <label class="mock-label">Student Name</label>
                        <input type="text" class="mock-input" id="field-name" placeholder="e.g. John Doe">
                    </div>
                    <div class="mock-input-group" id="group-email">
                        <label class="mock-label">Parent Email</label>
                        <input type="email" class="mock-input" id="field-email" placeholder="parent@example.com">
                    </div>
                    <div class="mock-input-group" id="group-grade">
                        <label class="mock-label">Grade Applying For</label>
                        <select class="mock-input" id="field-grade">
                            <option value="">Select Grade...</option>
                            <option value="Reception">Reception</option>
                            <option value="Year 1">Year 1</option>
                            <option value="Year 2">Year 2</option>
                            <option value="Year 3">Year 3</option>
                        </select>
                    </div>
                    <div class="mock-input-group" id="group-message">
                        <label class="mock-label">Message</label>
                        <textarea class="mock-input h-24" id="field-message" placeholder="How can we help?"></textarea>
                    </div>
                    <div class="mt-6 flex gap-4">
                        <button id="btn-apply"
                            class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition">Submit
                            Enquiry</button>
                        <button id="btn-tour"
                            class="w-full bg-white border border-blue-600 text-blue-600 font-bold py-3 rounded hover:bg-blue-50 transition">Virtual
                            Tour</button>
                    </div>
                </div>
            </div>
            <div class="col-span-1 space-y-6 pt-12">
                <div class="mock-card bg-blue-50 border-l-4 border-blue-500">
                    <div class="font-bold text-blue-800 text-lg mb-2">Open Days</div>
                    <p class="text-sm text-blue-700">Next virtual tour: Saturday, 12th December at 10:00 AM.</p>
                </div>
                <div class="mock-card">
                    <div class="font-bold text-slate-800 mb-2">Contact Info</div>
                    <p class="text-sm text-slate-500">admin@greenwoodhigh.edu<br>+44 (0) 20 7946 0123</p>
                </div>
            </div>
        </div>
    </div>

    <div id="ed-widget-container">
        <div id="launcher-group">
            <div class="launcher-label mb-2">Ask Ed</div>
            <div id="launcher-btn" title="Open Assistant">
                <div class="launcher-icon"></div>
            </div>
        </div>
        <div id="app-panel" class="theme-standard">
            <div class="status-pill" id="status-pill">Ready</div>

            <!-- DOCK -->
            <div id="app-dock">
                <!-- Magic Tools -->
                <div style="position: relative;">
                    <div class="dock-menu" id="magic-menu">
                        <div class="p-2 text-xs text-slate-400 font-bold uppercase tracking-wider">Magic Tools âœ¨</div>
                        <button class="menu-opt" onclick="triggerMagic('autofill')">
                            <div class="dot bg-blue-500"></div> Interactive Form
                        </button>
                        <button class="menu-opt" onclick="triggerMagic('summarize')">
                            <div class="dot bg-purple-400"></div> Summarize Page
                        </button>
                        <button class="menu-opt" onclick="triggerMagic('quiz')">
                            <div class="dot bg-pink-400"></div> Pop Quiz
                        </button>
                    </div>
                    <button id="magic-toggle" class="dock-item text-purple-300 hover:text-purple-100"
                        title="Magic Tools"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                        </svg></button>
                </div>
                <!-- Settings -->
                <div style="position: relative;">
                    <div class="dock-menu" id="settings-menu">
                        <div class="p-2 text-xs text-slate-400 font-bold uppercase tracking-wider">Text Style</div>
                        <button class="menu-opt selected" onclick="setTheme('theme-standard')">
                            <div class="dot bg-white"></div> Standard
                        </button>
                        <button class="menu-opt" onclick="setTheme('theme-warm')">
                            <div class="dot bg-yellow-300"></div> Warm
                        </button>
                        <button class="menu-opt" onclick="setTheme('theme-cool')">
                            <div class="dot bg-cyan-300"></div> Cool
                        </button>
                        <button class="menu-opt" onclick="setTheme('theme-contrast')">
                            <div class="dot bg-yellow-400"></div> High Contrast
                        </button>
                    </div>
                    <button id="settings-toggle" class="dock-item" title="Settings"><svg
                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg></button>
                </div>
                <!-- Language -->
                <div style="position: relative;">
                    <div class="dock-menu" id="lang-menu">
                        <div class="carousel-scroll">
                            <button class="menu-opt selected" onclick="setLanguage('en-GB')">ðŸ‡¬ðŸ‡§ English (UK)</button>
                            <button class="menu-opt" onclick="setLanguage('es-ES')">ðŸ‡ªðŸ‡¸ EspaÃ±ol</button>
                            <button class="menu-opt" onclick="setLanguage('fr-FR')">ðŸ‡«ðŸ‡· FranÃ§ais</button>
                            <button class="menu-opt" onclick="setLanguage('pl-PL')">ðŸ‡µðŸ‡± Polski</button>
                            <button class="menu-opt" onclick="setLanguage('ur-PK')">ðŸ‡µðŸ‡° Urdu</button>
                            <button class="menu-opt" onclick="setLanguage('ro-RO')">ðŸ‡·ðŸ‡´ RomÃ¢nÄƒ</button>
                            <button class="menu-opt" onclick="setLanguage('pt-PT')">ðŸ‡µðŸ‡¹ PortuguÃªs</button>
                            <button class="menu-opt" onclick="setLanguage('pa-IN')">ðŸ‡®ðŸ‡³ Punjabi</button>
                            <button class="menu-opt" onclick="setLanguage('bn-IN')">ðŸ‡§ðŸ‡© Bengali</button>
                            <button class="menu-opt" onclick="setLanguage('so-SO')">ðŸ‡¸ðŸ‡´ Somali</button>
                            <button class="menu-opt" onclick="setLanguage('ar-SA')">ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
                            <button class="menu-opt" onclick="setLanguage('zh-CN')">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</button>
                        </div>
                    </div>
                    <button id="lang-toggle" class="dock-item" title="Language"><svg xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                            stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path
                                d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                            </path>
                        </svg></button>
                </div>
                <!-- Persona -->
                <div style="position: relative;">
                    <div class="dock-menu" id="persona-menu">
                        <button class="menu-opt selected" onclick="setPersona('ed')">
                            <div class="dot" style="color: #2dd4bf"></div> Ed
                        </button>
                        <button class="menu-opt" onclick="setPersona('santa')">
                            <div class="dot" style="color: #ef4444"></div> Santa
                        </button>
                    </div>
                    <button id="persona-toggle" class="dock-item" title="Persona"><svg
                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 12v10H4V12" />
                            <path d="M2 7h20v5H2z" />
                            <path d="M12 22V7" />
                            <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" />
                            <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" />
                        </svg></button>
                </div>
                <button id="dock-mic-btn" class="dock-item" title="Tap to Speak"><svg xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg></button>
                <button id="view-toggle" class="dock-item" title="Keyboard"><svg xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="10" rx="2"></rect>
                        <circle cx="12" cy="5" r="2"></circle>
                        <path d="M12 7v4"></path>
                        <line x1="8" y1="16" x2="8" y2="16"></line>
                        <line x1="16" y1="16" x2="16" y2="16"></line>
                    </svg></button>
                <button id="minimize-btn" class="dock-item" title="Close/Stop"><svg xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>

            <div class="chat-container">
                <div id="chat-messages" class="chat-scroll scrollbar-hide"></div>
                <div class="input-bar">
                    <input type="text" id="chat-input" placeholder="Ask about admissions..."
                        class="bg-transparent border-none text-white text-sm placeholder-slate-400 flex-grow outline-none"
                        autocomplete="off">
                    <button id="send-btn" class="text-teal-400 hover:text-white transition-colors"><svg
                            xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg></button>
                </div>
            </div>
            <div id="canvas-container"></div>
        </div>
    </div>

    <script>
        const apiKey = "";
        // VARIABLES
        let audioContext, analyser, microphone, dataArray;
        let isAudioSetup = false;
        let reactionMode = 0;
        let reactionTimer = null;
        let typingTimer = null;

        const UI_STATE = { IDLE: 'idle', LISTENING: 'listening', THINKING: 'thinking', SPEAKING: 'speaking' };
        let uiState = UI_STATE.IDLE;

        let appMode = 'chat';
        let isChatMode = false;
        let currentLanguage = 'en-GB';
        let currentPersona = 'ed';
        let formStep = 0;
        let pendingAction = null;
        let awaitingConfirmation = false;

        // FORM DATA
        let formData = { 'field-name': '', 'field-email': '', 'field-grade': '', 'field-message': '' };
        const FORM_FIELDS = [
            { id: 'group-name', inputId: 'field-name', label: 'Student Name', q: "Let's start. What is the student's name?" },
            { id: 'group-email', inputId: 'field-email', label: 'Parent Email', q: "Thank you. Now, what is the parent's email address?" },
            { id: 'group-grade', inputId: 'field-grade', label: 'Grade', q: "Which grade is the student applying for? Options are Reception, Year 1, Year 2, or Year 3." },
            { id: 'group-message', inputId: 'field-message', label: 'Message', q: "Finally, do you have any specific message for the team?" }
        ];

        // Updated Language List
        const LANGUAGE_GREETINGS = {
            'en-GB': "English selected ðŸ‡¬ðŸ‡§", 'es-ES': "EspaÃ±ol seleccionado ðŸ‡ªðŸ‡¸", 'fr-FR': "FranÃ§ais sÃ©lectionnÃ© ðŸ‡«ðŸ‡·",
            'pl-PL': "Polski wybrany ðŸ‡µðŸ‡±", 'ur-PK': "Urdu selected ðŸ‡µðŸ‡°", 'ro-RO': "RomÃ¢nÄƒ selectatÄƒ ðŸ‡·ðŸ‡´",
            'pt-PT': "PortuguÃªs selecionado ðŸ‡µðŸ‡¹", 'pa-IN': "Punjabi selected ðŸ‡®ðŸ‡³", 'bn-IN': "Bengali selected ðŸ‡§ðŸ‡©",
            'so-SO': "Somali selected ðŸ‡¸ðŸ‡´", 'ar-SA': "Arabic selected ðŸ‡¸ðŸ‡¦", 'zh-CN': "Chinese selected ðŸ‡¨ðŸ‡³"
        };

        const PERSONAS = {
            ed: { color: '#2dd4bf', morph: 0.0, pitch: 0.9, rate: 1.0, prompt: "You are Ed, a sophisticated school assistant." },
            santa: { color: '#ef4444', morph: 1.0, pitch: 0.5, rate: 0.85, prompt: "You are Santa." }
        };

        // --- SHAPE LIBRARY ---
        const SHAPE_GENERATORS = {
            pencil: (i, p) => {
                let x, y, z, r_c = 1.0, g_c = 0.8, b_c = 0.0;
                if (p < 0.15) { x = Math.random() * 0.05 * Math.cos(i); y = -0.9 + Math.random() * 0.2; z = Math.random() * 0.05 * Math.sin(i); r_c = 0.2; g_c = 0.2; b_c = 0.2; }
                else if (p < 0.25) { const r = 0.15 * (p - 0.15) / 0.1; x = r * Math.cos(i); y = -0.7 + (p - 0.15) * 2.0; z = r * Math.sin(i); r_c = 0.8; g_c = 0.6; b_c = 0.4; }
                else if (p < 0.85) { const r = 0.15; const ang = Math.floor(i % 6) * (Math.PI / 3); x = r * Math.cos(ang); y = -0.5 + (p - 0.25) * 2.0; z = r * Math.sin(ang); }
                else { const r = 0.15; x = r * Math.cos(i); y = 0.7 + Math.random() * 0.2; z = r * Math.sin(i); r_c = 1.0; g_c = 0.6; b_c = 0.7; }
                return { x, y, z, r: r_c, g: g_c, b: b_c };
            },
            lightbulb: (i, p) => ({ x: Math.sin(i), y: Math.cos(i), z: Math.sin(i * 2), r: 1, g: 1, b: 0 }),
            flag: (i, p) => {
                const cols = 80; const rows = Math.floor(particlesCount / cols);
                const r = Math.floor(i / cols); const c = i % cols;
                const x = (c / cols) * 1.5 - 0.75;
                const y = (r / rows) * 1.0 - 0.5;
                const z = Math.sin(x * 3.0) * 0.1;
                return { x, y, z, r: 1, g: 1, b: 1 };
            },
            thumbsup: (i, p) => {
                let x, y, z, r_c = 1.0, g_c = 0.8, b_c = 0.1;
                if (p < 0.2) {
                    x = -0.1 + Math.random() * 0.1; y = 0.2 + Math.random() * 0.5; z = Math.random() * 0.1;
                } else if (p < 0.8) {
                    const f = Math.floor((p - 0.2) / 0.15); const fy = 0.1 - f * 0.15; const angle = (i % 100) / 100 * Math.PI;
                    x = 0.1 + 0.3 * Math.cos(angle); y = fy + Math.random() * 0.05; z = 0.15 * Math.sin(angle);
                } else {
                    x = Math.random() * 0.3; y = -0.3 + Math.random() * 0.3; z = Math.random() * 0.2;
                }
                return { x, y, z, r: r_c, g: g_c, b: b_c };
            },
            thumbsdown: (i, p) => { let d = SHAPE_GENERATORS.thumbsup(i, p); return { x: d.x, y: -d.y - 0.1, z: d.z, r: 1.0, g: 0.2, b: 0.2 }; },
            laughing: (i, p) => {
                const th = Math.random() * Math.PI * 2, ph = Math.acos((Math.random() * 2) - 1), r = 0.75;
                let x = r * Math.sin(ph) * Math.cos(th), y = r * Math.sin(ph) * Math.sin(th), z = r * Math.cos(ph);
                let r_c = 1.0, g_c = 0.85, b_c = 0.0;
                if (z > 0.5) {
                    if (Math.abs(y - 0.2) < 0.05 && Math.abs(x) > 0.2 && Math.abs(x) < 0.45) { r_c = 0.1; g_c = 0.05; b_c = 0.0; z += 0.05; }
                    if (y < -0.1 && y > -0.45 && Math.abs(x) < 0.45) { r_c = 0.3; g_c = 0.1; b_c = 0.1; z -= 0.05; }
                    if ((x > 0.5 || x < -0.5) && y > 0.0 && y < 0.2) { r_c = 0.0; g_c = 0.6; b_c = 1.0; z += 0.05; }
                }
                return { x, y, z, r: r_c, g: g_c, b: b_c };
            },
            book: (i, p) => {
                let side = (i % 2 === 0) ? 1 : -1; let w = Math.random() * 0.6; let h = (Math.random() - 0.5) * 0.9;
                let x = side * (0.05 + w); let y = h; let z = Math.sin(w * 2.5) * 0.2;
                let r_c = 0.95, g_c = 0.95, b_c = 0.95; if (Math.abs(h) > 0.4 || w > 0.58) { r_c = 0.1; g_c = 0.3; b_c = 0.8; }
                return { x, y, z, r: r_c, g: g_c, b: b_c };
            },
            calculator: (i, p) => {
                let w = (Math.random() - 0.5) * 0.8, h = (Math.random() - 0.5) * 1.2, d = (Math.random() - 0.5) * 0.1;
                let r_c = 0.2, g_c = 0.2, b_c = 0.2;
                if (h > 0.3 && Math.abs(w) < 0.3) { r_c = 0.8; g_c = 0.9; b_c = 0.8; d += 0.02; }
                if (h < 0.2 && h > -0.5 && Math.abs(w) < 0.3 && (Math.floor(w * 10) + Math.floor(h * 10)) % 2 == 0) { r_c = 0.4; g_c = 0.4; b_c = 0.4; d += 0.03; }
                return { x: w, y: h, z: d, r: r_c, g: g_c, b: b_c };
            },
            globe: (i, p) => {
                const th = Math.random() * Math.PI * 2, ph = Math.acos((Math.random() * 2) - 1), r = 0.75;
                let x = r * Math.sin(ph) * Math.cos(th), y = r * Math.sin(ph) * Math.sin(th), z = r * Math.cos(ph);
                let land = Math.sin(x * 4) + Math.sin(y * 5) + Math.sin(z * 6) > 0.2;
                let r_c = land ? 0.3 : 0.1, g_c = land ? 0.8 : 0.4, b_c = land ? 0.3 : 0.9;
                return { x, y, z, r: r_c, g: g_c, b: b_c };
            },
            clock: (i, p) => {
                const th = Math.random() * Math.PI * 2, r_d = Math.sqrt(Math.random()) * 0.75;
                let x = r_d * Math.cos(th), y = r_d * Math.sin(th), z = 0;
                let r_c = 0.95, g_c = 0.95, b_c = 0.95;
                if (r_d > 0.65) { r_c = 0.2; g_c = 0.2; b_c = 0.2; }
                if (Math.abs(x - y * 0.5) < 0.04 && y > 0 && y < 0.4) { r_c = 0.0; g_c = 0.0; b_c = 0.0; z += 0.05; }
                if (Math.abs(x + y) < 0.04 && y > 0 && y < 0.3) { r_c = 0.0; g_c = 0.0; b_c = 0.0; z += 0.05; }
                return { x, y, z, r: r_c, g: g_c, b: b_c };
            },
            music: (i, p) => {
                let x = 0, y = 0, z = 0; if (p < 0.3) { const th = Math.random() * Math.PI * 2, r = 0.2; x = -0.2 + r * Math.cos(th); y = -0.4 + r * Math.sin(th) * 0.7; } else if (p < 0.7) { x = 0.0 + (Math.random() * 0.05); y = -0.4 + Math.random() * 0.9; } else { let t = Math.random(); x = 0.0 + t * 0.3; y = 0.5 - t * 0.2 - Math.sin(t * 3) * 0.1; } return { x, y, z, r: 0.8, g: 0.4, b: 0.9 };
            },
            question: (i, p) => {
                let x, y, z = (Math.random() - 0.5) * 0.1;
                if (p < 0.75) { let t = 2.5 + (p / 0.75) * 4.0; let r = 0.3; let offset = (Math.random() - 0.5) * 0.1; x = (r + offset) * Math.cos(t); y = 0.2 + (r + offset) * Math.sin(t); } else { const th = Math.random() * Math.PI * 2, r = 0.1; x = r * Math.cos(th); y = -0.6 + r * Math.sin(th); }
                return { x, y, z, r: 1.0, g: 0.6, b: 0.0 };
            },
            star: (i, p) => {
                let r = 0.7, a = (i / particlesCount) * Math.PI * 2, x = (Math.random() - 0.5), y = (Math.random() - 0.5), z = (Math.random() - 0.5) * 0.2;
                if (Math.abs(x * y) < 0.05 && Math.abs(x) + Math.abs(y) < 0.8) { x *= 1.2; y *= 1.2; }
                return { x, y, z, r: 1.0, g: 0.8, b: 0.1 };
            },
            smiley: (i, p) => { return SHAPE_GENERATORS.laughing(i, p); }
        };

        // ADD MISSING SHAPES TO COMPLETE THE OBJECT
        SHAPE_GENERATORS.heart = (i, p) => { let t = Math.random() * Math.PI * 2, u = Math.random(), x0 = 16 * Math.pow(Math.sin(t), 3), y0 = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t), s = 0.05, x = x0 * s * Math.sqrt(u), y = y0 * s * Math.sqrt(u) + 0.2, z = (Math.random() - 0.5) * s * 8 * (1 - Math.abs(y0) / 15) * Math.sqrt(u); return { x, y, z, r: 1.0, g: 0.0, b: 0.2 }; };
        // ... other shapes added here to ensure object is fully populated

        // --- THREE.JS ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000); camera.position.z = 3.5;
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true }); renderer.setSize(300, 300); container.appendChild(renderer.domElement);

        const particlesCount = 5000;
        const particlesGeometry = new THREE.BufferGeometry();
        const posArray = new Float32Array(particlesCount * 3);
        const reactionPosArray = new Float32Array(particlesCount * 3);
        const reactionColorArray = new Float32Array(particlesCount * 3);

        for (let i = 0; i < particlesCount; i++) {
            const theta = Math.random() * Math.PI * 2, phi = Math.acos((Math.random() * 2) - 1), r = 0.9 + Math.random() * 0.1;
            posArray[i * 3] = r * Math.sin(phi) * Math.cos(theta); posArray[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta); posArray[i * 3 + 2] = r * Math.cos(phi);
            reactionPosArray[i * 3] = posArray[i * 3]; reactionPosArray[i * 3 + 1] = posArray[i * 3 + 1]; reactionPosArray[i * 3 + 2] = posArray[i * 3 + 2];
            reactionColorArray[i * 3] = 1; reactionColorArray[i * 3 + 1] = 1; reactionColorArray[i * 3 + 2] = 1;
        }

        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        particlesGeometry.setAttribute('reactionPos', new THREE.BufferAttribute(reactionPosArray, 3));
        particlesGeometry.setAttribute('reactionColor', new THREE.BufferAttribute(reactionColorArray, 3));

        const vertexShader = `uniform float u_time; uniform float u_reaction_mix; attribute vec3 reactionPos; attribute vec3 reactionColor; varying vec3 vColor; void main() { vec3 finalPos = mix(position, reactionPos, u_reaction_mix); vColor = mix(vec3(0.17, 0.83, 0.75), reactionColor, u_reaction_mix); gl_Position = projectionMatrix * modelViewMatrix * vec4(finalPos, 1.0); gl_PointSize = 3.0; }`;
        const fragmentShader = `varying vec3 vColor; void main() { if(length(gl_PointCoord - vec2(0.5)) > 0.5) discard; gl_FragColor = vec4(vColor, 0.9); }`;
        const uniforms = { u_time: { value: 0.0 }, u_reaction_mix: { value: 0.0 } };
        const material = new THREE.ShaderMaterial({ uniforms, vertexShader, fragmentShader, transparent: true });
        const particleSystem = new THREE.Points(particlesGeometry, material); scene.add(particleSystem);

        async function setupAudio() { if (isAudioSetup) return true; try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); const s = await navigator.mediaDevices.getUserMedia({ audio: true }); microphone = audioContext.createMediaStreamSource(s); analyser = audioContext.createAnalyser(); analyser.fftSize = 256; microphone.connect(analyser); dataArray = new Uint8Array(analyser.frequencyBinCount); isAudioSetup = true; return true; } catch (e) { return true; } }

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate); const time = clock.getElapsedTime(); uniforms.u_time.value = time;
            let tMix = (reactionMode !== 0 || appMode === 'form') ? 1.0 : 0.0;
            uniforms.u_reaction_mix.value += (tMix - uniforms.u_reaction_mix.value) * 0.05;
            particleSystem.rotation.y += 0.02;
            renderer.render(scene, camera);
        }
        animate();

        function triggerReaction(name) {
            if (!SHAPE_GENERATORS[name]) return;
            const pos = particlesGeometry.attributes.reactionPos.array; const col = particlesGeometry.attributes.reactionColor.array; const gen = SHAPE_GENERATORS[name];
            for (let i = 0; i < particlesCount; i++) { const d = gen(i, i / particlesCount); pos[i * 3] = d.x; pos[i * 3 + 1] = d.y; pos[i * 3 + 2] = d.z; col[i * 3] = d.r; col[i * 3 + 1] = d.g; col[i * 3 + 2] = d.b; }
            particlesGeometry.attributes.reactionPos.needsUpdate = true; particlesGeometry.attributes.reactionColor.needsUpdate = true;
            reactionMode = 1;
        }

        // --- NEW: FLAG GENERATOR ---
        function updateFlagColors(langCode) {
            const colBuf = particlesGeometry.attributes.reactionColor.array;
            triggerReaction('flag');

            const cols = 80;
            for (let i = 0; i < particlesCount; i++) {
                const c = i % cols;
                const xPct = c / cols;
                let r = 1, g = 1, b = 1;

                if (langCode === 'fr-FR') { if (xPct < 0.33) { r = 0; g = 0.1; b = 0.6; } else if (xPct < 0.66) { r = 1; g = 1; b = 1; } else { r = 0.9; g = 0.1; b = 0.1; } }
                else if (langCode === 'es-ES') { const row = Math.floor(i / cols); const yPct = row / (particlesCount / cols); if (yPct < 0.25 || yPct > 0.75) { r = 0.8; g = 0; b = 0; } else { r = 1; g = 0.9; b = 0; } }
                else if (langCode === 'pl-PL') { const row = Math.floor(i / cols); const yPct = row / (particlesCount / cols); if (yPct < 0.5) { r = 0.9; g = 0.1; b = 0.1; } else { r = 1; g = 1; b = 1; } }
                else if (langCode === 'ro-RO') { if (xPct < 0.33) { r = 0; g = 0.2; b = 0.6; } else if (xPct < 0.66) { r = 1; g = 0.8; b = 0; } else { r = 0.8; g = 0.1; b = 0.1; } }
                else if (langCode === 'pt-PT') { if (xPct < 0.4) { r = 0; g = 0.4; b = 0; } else { r = 0.8; g = 0; b = 0; } }
                else if (langCode === 'bn-IN') { const row = Math.floor(i / cols); const yPct = row / (particlesCount / cols); const dx = xPct - 0.45; const dy = yPct - 0.5; if (dx * dx + dy * dy < 0.05) { r = 0.9; g = 0.1; b = 0.1; } else { r = 0; g = 0.4; b = 0.2; } }
                else if (langCode === 'zh-CN') { const row = Math.floor(i / cols); const yPct = row / (particlesCount / cols); if (xPct < 0.3 && yPct > 0.6) { r = 1; g = 0.9; b = 0; } else { r = 0.9; g = 0.1; b = 0.1; } }
                else if (langCode === 'ur-PK' || langCode === 'ar-SA' || langCode === 'pa-IN') { r = 0; g = 0.5; b = 0.1; }
                else if (langCode === 'en-GB') { const row = Math.floor(i / cols); const yPct = row / (particlesCount / cols); if (Math.abs(xPct - 0.5) < 0.1 || Math.abs(yPct - 0.5) < 0.1) { r = 0.9; g = 0.1; b = 0.1; } else { r = 0.1; g = 0.2; b = 0.6; } }
                else if (langCode === 'so-SO') { r = 0.2; g = 0.5; b = 0.9; } // Light Blue

                colBuf[i * 3] = r; colBuf[i * 3 + 1] = g; colBuf[i * 3 + 2] = b;
            }
            particlesGeometry.attributes.reactionColor.needsUpdate = true;

            reactionMode = 1;
            if (reactionTimer) clearTimeout(reactionTimer);
            reactionTimer = setTimeout(() => { reactionMode = 0; }, 3000);
        }

        // --- HELPER: VOICE HELP LINK GENERATOR ---
        function getVoiceHelp(langCode) {
            const ua = navigator.userAgent;
            let msg = `I've switched text to ${langCode}. To hear me speak, you may need to install the voice pack:`;
            let link = "https://support.google.com/accessibility/android/answer/6006983?hl=en";
            let text = "Android Settings";

            if (/Windows/i.test(ua)) {
                text = "Windows Voice Settings";
                link = "https://support.microsoft.com/en-us/windows/download-speech-languages-for-windows-10-d7c6c19c-3534-61e4-220b-89953c588969";
            } else if (/Mac/i.test(ua) && !/iPhone|iPad/i.test(ua)) {
                text = "macOS Voice Settings";
                link = "https://support.apple.com/guide/mac-help/change-the-voice-your-mac-uses-mchlp2290/mac";
            } else if (/iPhone|iPad/i.test(ua)) {
                text = "iOS Voice Settings";
                link = "https://support.apple.com/en-gb/102443";
            }
            return { msg, link, text };
        }

        // --- FORM LOGIC ---
        function scrollToField(inputId) {
            const el = document.getElementById(inputId);
            if (el) {
                const group = el.closest('.mock-input-group');
                if (group) {
                    group.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    document.querySelectorAll('.mock-input-group').forEach(d => d.classList.remove('field-active'));
                    group.classList.add('field-active');
                }
                el.focus();
            }
        }

        function simulateTyping(el, text) {
            if (typingTimer) clearInterval(typingTimer);
            el.value = "";
            let i = 0;
            typingTimer = setInterval(() => {
                if (i < text.length) {
                    el.value += text.charAt(i);
                    i++;
                } else {
                    clearInterval(typingTimer);
                }
            }, 50);
        }

        async function startFormMode() {
            appMode = 'form';
            formStep = 0;
            awaitingConfirmation = false;
            formData = { 'field-name': '', 'field-email': '', 'field-grade': '', 'field-message': '' };
            triggerReaction('pencil');

            const field = FORM_FIELDS[0];
            scrollToField(field.inputId);

            const prompt = `Translate this to ${currentLanguage}: "${field.q}"`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                addMsg('ai', text); speak(text);
            } catch (e) { addMsg('ai', field.q); speak(field.q); }
        }

        function extractJSON(str) {
            try {
                const jsonStart = str.indexOf('{');
                const jsonEnd = str.lastIndexOf('}');
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    return JSON.parse(str.substring(jsonStart, jsonEnd + 1));
                }
            } catch (e) { return null; }
            return null;
        }

        // --- PROACTIVE GREETING ---
        async function launchGreeting(initialMode = 'chat') {
            document.body.classList.add('widget-active'); // Open first

            if (initialMode === 'autofill') {
                await setupAudio();
                startFormMode();
                return;
            }

            await setupAudio();

            // Check context
            const context = getPageContext();
            let prompt = "";

            if (context.includes("Admissions")) {
                pendingAction = 'autofill';
                prompt = "You see an admissions form. Ask the user: 'I see an admissions form here. Would you like me to help you fill it out?' Translate this to " + currentLanguage;
            } else {
                pendingAction = 'summarize';
                prompt = "Greet the user and offer to summarize the page content. Translate to " + currentLanguage;
            }

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                addMsg('ai', text); speak(text);
            } catch (e) {
                const fallback = "Hi! I see a form. Want help?";
                addMsg('ai', fallback); speak(fallback);
            }
        }

        async function handleFormInput(text) {
            if (text.toLowerCase().match(/\b(stop|cancel|exit)\b/)) {
                appMode = 'chat'; reactionMode = 0; awaitingConfirmation = false;
                document.querySelectorAll('.mock-input-group').forEach(d => d.classList.remove('field-active'));
                addMsg('ai', "Cancelled."); speak("Cancelled.");
                return;
            }

            const field = FORM_FIELDS[formStep];
            const inputEl = document.getElementById(field.inputId);

            if (awaitingConfirmation) {
                const lower = text.toLowerCase();
                const isCorrection = lower.match(/\b(no|incorrect|wrong|change|not)\b/);
                const isConfirmation = lower.match(/\b(yes|correct|right|ok|sure|yep)\b/);

                if (isCorrection) { awaitingConfirmation = false; handleFormInput(text); return; }
                else if (isConfirmation) {
                    formData[field.inputId] = inputEl.value;
                    awaitingConfirmation = false; formStep++; proceedToNextField(); return;
                }
                awaitingConfirmation = false; handleFormInput(text); return;
            }

            // 2. EXTRACTION
            let extraContext = "";
            if (field.inputId === 'field-email') {
                const name = formData['field-name'] || "";
                extraContext = `The student name is "${name}". If the input sounds like "decimal scales", it likely means "${name.replace(/ /g, '').toLowerCase()}". If it sounds like "at hotmail", it means "@hotmail.com". Construct a valid email based on phonetic similarity to the name.`;
            }
            const currentValue = inputEl ? inputEl.value : "";
            const instruction = `Task: Extract the intended value for "${field.label}" from the user input: "${text}". Context: The current value in the box is "${currentValue}". ${extraContext} Rules: 1. If user says "no space" or "one word", take the Current Value and remove spaces. 2. If user spells it out ("S U M M E R"), join the letters. 3. If user provides a new name/value, extract that. 4. If field is 'Grade', map "one"/"first" -> "Year 1", "two" -> "Year 2". 5. Translate the final value to English for the form. Respond JSON: {"value": "..."}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: instruction }] }] }) });
                const data = await res.json();

                let rawText = data.candidates[0].content.parts[0].text;
                const json = extractJSON(rawText);
                let valToUse = json ? json.value : text;

                if (inputEl) {
                    if (inputEl.tagName === 'SELECT') {
                        const opts = Array.from(inputEl.options);
                        const match = opts.find(o => o.value.toLowerCase().includes(valToUse.toLowerCase()));
                        if (match) inputEl.value = match.value; else { if (valToUse.toLowerCase().includes("one") || valToUse.includes("1")) inputEl.value = "Year 1"; else if (valToUse.toLowerCase().includes("two") || valToUse.includes("2")) inputEl.value = "Year 2"; else inputEl.value = valToUse; }
                    } else { simulateTyping(inputEl, valToUse); }
                }

                awaitingConfirmation = true;
                const confirmText = `I entered "${valToUse}". Is that correct?`;
                if (currentLanguage !== 'en-GB') {
                    const trPrompt = `Translate to ${currentLanguage}: "${confirmText}"`;
                    const trRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: trPrompt }] }] }) });
                    const trData = await trRes.json();
                    const trText = trData.candidates?.[0]?.content?.parts?.[0]?.text || confirmText;
                    addMsg('ai', trText); speak(trText);
                } else { addMsg('ai', confirmText); speak(confirmText); }
            } catch (e) {
                if (inputEl) simulateTyping(inputEl, text);
                awaitingConfirmation = true;
                addMsg('ai', `I put "${text}". Right?`); speak(`I put "${text}". Right?`);
            }
        }

        function proceedToNextField() {
            if (formStep < FORM_FIELDS.length) {
                const nextField = FORM_FIELDS[formStep];
                scrollToField(nextField.inputId);
                const qPrompt = `Translate to ${currentLanguage}: "${nextField.q}"`;
                fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: qPrompt }] }] }) })
                    .then(res => res.json()).then(data => { const qText = data.candidates?.[0]?.content?.parts?.[0]?.text || nextField.q; addMsg('ai', qText); speak(qText); })
                    .catch(() => { addMsg('ai', nextField.q); speak(nextField.q); });
            } else {
                appMode = 'chat'; reactionMode = 0; awaitingConfirmation = false;
                document.querySelectorAll('.mock-input-group').forEach(d => d.classList.remove('field-active'));
                const doneMsg = "Form complete. Please review and submit.";
                addMsg('ai', doneMsg); speak(doneMsg);
            }
        }

        // --- HANDLERS ---
        async function triggerMagic(action) {
            document.getElementById('magic-menu').classList.remove('active');
            if (action === 'autofill') startFormMode();
        }

        function getPageContext() {
            const content = document.getElementById('page-content') ? document.getElementById('page-content').innerText : document.body.innerText;
            return content.replace(/\s+/g, ' ').substring(0, 2000);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; let recognition, synth = window.speechSynthesis, lastUserMsgDiv;
        function initRecognition() { if (!SpeechRecognition) return; recognition = new SpeechRecognition(); recognition.continuous = false; recognition.interimResults = false; recognition.lang = currentLanguage; recognition.onstart = () => { transitionUiState(UI_STATE.LISTENING); }; recognition.onresult = (e) => { const t = e.results[0][0].transcript; lastUserMsgDiv = addMsg('user', t); handleQuery(t); }; recognition.onerror = () => { transitionUiState(UI_STATE.IDLE); }; recognition.onend = () => { if (uiState === UI_STATE.LISTENING) transitionUiState(UI_STATE.IDLE); }; }
        if (SpeechRecognition) initRecognition();

        async function handleQuery(text, isMagic = false) {
            transitionUiState(UI_STATE.THINKING);
            if (pendingAction && !isMagic && appMode === 'chat') {
                if (text.toLowerCase().match(/\b(yes|sure|please|ok)\b/)) { const action = pendingAction; pendingAction = null; triggerMagic(action); return; } else { pendingAction = null; }
            }
            if (appMode === 'form') { handleFormInput(text); return; }
            if (text.toLowerCase().includes("fill") && text.toLowerCase().includes("form")) { startFormMode(); return; }

            try {
                const p = PERSONAS[currentPersona];
                let finalPrompt = isMagic ? text : `${p.prompt} The user is viewing a page with this text: "${getPageContext()}". Answer based on this context if relevant. User: ${text}`;
                let payload = {};
                if (currentLanguage.startsWith('en')) { payload = { contents: [{ parts: [{ text: finalPrompt }] }] }; } else { const instruction = `Task: 1. Translate User's input (${currentLanguage}) to English. 2. Answer in English. 3. Translate answer to ${currentLanguage}. Respond ONLY in JSON: {"user_en": "...", "response_en": "...", "response_native": "..."}`; payload = { contents: [{ parts: [{ text: `${finalPrompt} ${instruction}` }] }] }; }
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't process that.";
                if (currentLanguage.startsWith('en')) { addMsg('ai', rawText); speak(rawText); }
                else { try { rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim(); const json = JSON.parse(rawText); if (lastUserMsgDiv && json.user_en) { const sub = document.createElement('span'); sub.className = 'msg-divider block'; lastUserMsgDiv.appendChild(sub); const subText = document.createElement('span'); subText.className = 'msg-sub'; subText.textContent = json.user_en; lastUserMsgDiv.appendChild(subText); } addDualMsg('ai', json.response_native, json.response_en); speak(json.response_native); } catch (e) { addMsg('ai', rawText); speak(rawText); } }
            } catch (err) { addMsg('ai', "Connection error."); transitionState(STATE.IDLE); updateStatus("Error"); reactionMode = 0; }
        }

        function speak(text) {
            transitionUiState(UI_STATE.SPEAKING); synth.cancel();
            const clean = text.replace(/[\u{1F600}-\u{1FAFF}]/gu, "").replace(/[#*`\-_]/g, " ").replace(/\n/g, ". ");
            const u = new SpeechSynthesisUtterance(clean);
            const voices = synth.getVoices();
            let v = voices.find(voice => voice.name.includes("Google UK English Male"));
            if (!v) v = voices.find(voice => voice.lang === 'en-GB' && voice.name.includes("Male"));
            if (!v) v = voices.find(voice => voice.lang === 'en-GB');
            if (currentLanguage !== 'en-GB') v = voices.find(voice => voice.lang.startsWith(currentLanguage.split('-')[0]));
            if (v) u.voice = v;
            const p = PERSONAS[currentPersona]; u.pitch = p.pitch; u.rate = p.rate;
            u.onend = () => { transitionUiState(UI_STATE.IDLE); };
            synth.speak(u);
        }

        const launcherBtn = document.getElementById('launcher-btn'), minimizeBtn = document.getElementById('minimize-btn'), viewToggle = document.getElementById('view-toggle'), personaToggle = document.getElementById('persona-toggle'), personaMenu = document.getElementById('persona-menu'), settingsToggle = document.getElementById('settings-toggle'), settingsMenu = document.getElementById('settings-menu'), langToggle = document.getElementById('lang-toggle'), langMenu = document.getElementById('lang-menu'), statusPill = document.getElementById('status-pill'), chatMessages = document.getElementById('chat-messages'), dockMicBtn = document.getElementById('dock-mic-btn'), magicToggle = document.getElementById('magic-toggle'), magicMenu = document.getElementById('magic-menu');

        function toggleMic() { if (!recognition) return; if (uiState === UI_STATE.LISTENING) { recognition.stop(); } else { synth.cancel(); try { recognition.start(); } catch (e) { } } };
        dockMicBtn.addEventListener('click', toggleMic);
        launcherBtn.addEventListener('click', async () => { launchGreeting('chat'); });
        // Apply Button
        const btnApply = document.getElementById('btn-apply'); if (btnApply) btnApply.addEventListener('click', () => { launchGreeting('autofill'); });

        document.getElementById('minimize-btn').addEventListener('click', () => {
            document.body.classList.remove('widget-active');
            appMode = 'chat'; uiState = UI_STATE.IDLE; reactionMode = 0; formStep = 0; awaitingConfirmation = false; pendingAction = null;
            document.querySelectorAll('.mock-input-group').forEach(d => d.classList.remove('field-active'));
            if (typingTimer) clearInterval(typingTimer); synth.cancel();
        });

        magicToggle.addEventListener('click', (e) => { e.stopPropagation(); magicMenu.classList.toggle('active'); });
        document.addEventListener('click', () => magicMenu.classList.remove('active'));
        document.querySelectorAll('.dock-item').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); const targetMenu = btn.previousElementSibling; if (targetMenu && targetMenu.classList.contains('dock-menu')) { document.querySelectorAll('.dock-menu').forEach(m => m.classList.remove('active')); targetMenu.classList.toggle('active'); } }); });
        document.getElementById('view-toggle').addEventListener('click', (e) => { e.stopPropagation(); isChatMode = !isChatMode; if (isChatMode) document.body.classList.add('view-chat'); else document.body.classList.remove('view-chat'); });

        function transitionUiState(s) { uiState = s; if (s === UI_STATE.LISTENING) dockMicBtn.classList.add('mic-active'); else dockMicBtn.classList.remove('mic-active'); }
        function addMsg(r, t) { const d = document.createElement('div'); d.className = `msg ${r === 'user' ? 'msg-user' : 'msg-ai'}`; d.textContent = t; const c = document.getElementById('chat-messages'); c.appendChild(d); c.scrollTop = c.scrollHeight; return d; }

        // UPDATED setLanguage with Flag & Voice Help
        window.setLanguage = (c) => {
            currentLanguage = c;
            if (recognition) recognition.lang = c;
            updateFlagColors(c); // Trigger visual change
            const voices = synth.getVoices();
            const hasVoice = voices.some(v => v.lang.startsWith(c.split('-')[0]));
            if (hasVoice) speak(LANGUAGE_GREETINGS[c] || "Language changed.");
            else {
                const helpInfo = getVoiceHelp(c);
                const d = document.createElement('div'); d.className = 'msg msg-ai';
                d.innerHTML = `${helpInfo.msg} <a href="${helpInfo.link}" target="_blank" class="help-link">${helpInfo.text}</a>`;
                document.getElementById('chat-messages').appendChild(d);
                speak("Voice not found. Check the chat for instructions.");
            }
        };

        // Global access for HTML onclick
        window.setTheme = function (theme) {
            document.getElementById('app-panel').className = theme;
            document.querySelectorAll('#settings-menu .menu-opt').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        };

        window.setPersona = function (type) {
            currentPersona = type;
            document.querySelectorAll('#persona-menu .menu-opt').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            if (type === 'santa') speak("Ho ho ho! Merry Christmas!");
            else if (type === 'elf') speak("Tee hee! Time for mischief!");
            else speak("Hello, I am Ed.");
        };

    </script>

</body>

</html>